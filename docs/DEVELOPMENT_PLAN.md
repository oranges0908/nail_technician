# ç¾ç”²å¸ˆèƒ½åŠ›æˆé•¿ç³»ç»Ÿ - å¼€å‘æµç¨‹è§„åˆ’

## æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æŒ‰ç…§**æ¡†æ¶å±‚ â†’ åŸºç¡€æ¨¡å— â†’ ä¸šåŠ¡æ¨¡å—**çš„é¡ºåºï¼Œå°†ç³»ç»Ÿå¼€å‘åˆ†è§£ä¸ºå¤šä¸ªè¿­ä»£ï¼ˆIterationï¼‰ï¼Œæ¯ä¸ªè¿­ä»£æ§åˆ¶åœ¨**1000è¡Œä»£ç ä»¥å†…**ã€‚

### å¼€å‘åŸåˆ™

1. **è¿­ä»£å¼€å‘æµç¨‹**ï¼šæ¯ä¸ªè¿­ä»£ä¸¥æ ¼éµå¾ª **åˆ†æ â†’ è®¾è®¡ â†’ å®ç° â†’ æµ‹è¯• â†’ æ ¡å¯¹ä¿®æ­£** çš„å¾ªç¯
2. **ä»£ç æ§åˆ¶**ï¼šæ¯ä¸ªè¿­ä»£ä»£ç é‡æ§åˆ¶åœ¨1000è¡Œä»¥å†…ï¼Œç¡®ä¿è´¨é‡å’Œå¯å®¡æŸ¥æ€§
3. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ¯å®Œæˆä¸€ä¸ªè¿­ä»£ï¼Œå¿…é¡»åˆ›å»ºGit commitèŠ‚ç‚¹ï¼Œè®°å½•æ”¹åŠ¨æ¦‚è¦
4. **å®šæœŸæ•´ç†**ï¼šæ¯å®Œæˆä¸€ä¸ªé˜¶æ®µæˆ–3-5ä¸ªè¿­ä»£åï¼Œè¿›è¡ŒClaude compactæ•´ç†ä¸Šä¸‹æ–‡
5. **è´¨é‡ä¿è¯**ï¼šæ¯ä¸ªè¿­ä»£å¿…é¡»é€šè¿‡æµ‹è¯•ï¼Œç¡®ä¿åŠŸèƒ½å®Œæ•´ä¸”æ— bugåæ‰èƒ½è¿›å…¥ä¸‹ä¸€è¿­ä»£

---

## å¼€å‘é˜¶æ®µæ¦‚è§ˆ

```
é˜¶æ®µ1: æ¡†æ¶å±‚ (5ä¸ªè¿­ä»£)
  â”œâ”€â”€ Iteration 1.1: æ•°æ®åº“åŸºç¡€è®¾æ–½
  â”œâ”€â”€ Iteration 1.2: è®¤è¯ä¸æˆæƒç³»ç»Ÿ
  â”œâ”€â”€ Iteration 1.3: æ–‡ä»¶ä¸Šä¼ æœåŠ¡
  â”œâ”€â”€ Iteration 1.4: é”™è¯¯å¤„ç†ä¸æ—¥å¿—
  â””â”€â”€ Iteration 1.5: APIæ–‡æ¡£ä¸å¥åº·æ£€æŸ¥

é˜¶æ®µ2: åŸºç¡€æ¨¡å— (3ä¸ªè¿­ä»£)
  â”œâ”€â”€ Iteration 2.1: ç”¨æˆ·ç®¡ç†æ¨¡å—
  â”œâ”€â”€ Iteration 2.2: å®¢æˆ·æ¡£æ¡ˆç®¡ç†
  â””â”€â”€ Iteration 2.3: å®¢æˆ·è¯¦ç»†æ¡£æ¡ˆ

é˜¶æ®µ3: AIæŠ½è±¡å±‚ (2ä¸ªè¿­ä»£)
  â”œâ”€â”€ Iteration 3.1: AI ProvideræŠ½è±¡æ¥å£
  â””â”€â”€ Iteration 3.2: OpenAI Providerå®ç°

é˜¶æ®µ4: æ ¸å¿ƒä¸šåŠ¡æ¨¡å— (7ä¸ªè¿­ä»£)
  â”œâ”€â”€ Iteration 4.1: çµæ„Ÿå›¾åº“ç®¡ç†
  â”œâ”€â”€ Iteration 4.2: AIè®¾è®¡æ–¹æ¡ˆç”Ÿæˆ
  â”œâ”€â”€ Iteration 4.3: è®¾è®¡æ–¹æ¡ˆå¾®è°ƒ
  â”œâ”€â”€ Iteration 4.4: æœåŠ¡è®°å½•ç®¡ç†
  â”œâ”€â”€ Iteration 4.5: AIå¯¹æ¯”åˆ†æ
  â”œâ”€â”€ Iteration 4.6: èƒ½åŠ›ç»´åº¦ç®¡ç†
  â””â”€â”€ Iteration 4.7: èƒ½åŠ›åˆ†æä¸å¯è§†åŒ–

é˜¶æ®µ5: å‰ç«¯å¼€å‘ (6ä¸ªè¿­ä»£)
  â”œâ”€â”€ Iteration 5.1: Flutteré¡¹ç›®åŸºç¡€æ¶æ„
  â”œâ”€â”€ Iteration 5.2: è®¤è¯ä¸ç”¨æˆ·æ¨¡å—
  â”œâ”€â”€ Iteration 5.3: å®¢æˆ·ç®¡ç†ç•Œé¢
  â”œâ”€â”€ Iteration 5.4: è®¾è®¡ç”Ÿæˆç•Œé¢
  â”œâ”€â”€ Iteration 5.5: æœåŠ¡è®°å½•ç•Œé¢
  â””â”€â”€ Iteration 5.6: èƒ½åŠ›ä¸­å¿ƒç•Œé¢

æ€»è®¡: 23ä¸ªè¿­ä»£
```

---

## é˜¶æ®µ1: æ¡†æ¶å±‚ (Backend Foundation)

### Iteration 1.1: æ•°æ®åº“åŸºç¡€è®¾æ–½

**ç›®æ ‡**: å»ºç«‹æ•°æ®åº“è¿æ¥ã€è¿ç§»ç³»ç»Ÿã€åŸºç¡€æ¨¡å‹

**ä»£ç é‡ä¼°ç®—**: ~300è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- æ”¯æŒPostgreSQLã€MySQLã€SQLiteä¸‰ç§æ•°æ®åº“
- ä½¿ç”¨SQLAlchemy ORM
- ä½¿ç”¨Alembicè¿›è¡Œæ•°æ®åº“è¿ç§»
- å»ºç«‹æ•°æ®åº“ä¼šè¯ç®¡ç†å’Œä¾èµ–æ³¨å…¥

**æŠ€æœ¯é€‰å‹**:
- SQLAlchemy 2.0+ (å·²ç¡®å®š)
- Alembic (å·²ç¡®å®š)
- æ•°æ®åº“URLé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®

#### 2. è®¾è®¡ (Design)

**æ–‡ä»¶ç»“æ„**:
```
backend/
â”œâ”€â”€ alembic/                    # æ–°å»º
â”‚   â”œâ”€â”€ versions/
â”‚   â”œâ”€â”€ env.py
â”‚   â””â”€â”€ script.py.mako
â”œâ”€â”€ alembic.ini                 # æ–°å»º
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ database.py        # å·²å­˜åœ¨ï¼Œéœ€å®Œå–„
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ __init__.py        # å·²å­˜åœ¨ï¼Œéœ€å®Œå–„
```

**æ•°æ®åº“é…ç½®è®¾è®¡**:
- `database.py`: å¢å¼ºæ•°æ®åº“å¼•æ“é…ç½®ï¼ˆè¿æ¥æ± ã€è¶…æ—¶ç­‰ï¼‰
- `alembic/env.py`: é…ç½®è¿ç§»ç¯å¢ƒï¼Œè‡ªåŠ¨å¯¼å…¥æ‰€æœ‰æ¨¡å‹

**è¿ç§»ç­–ç•¥**:
- åˆå§‹åŒ–Alembic
- é…ç½®`env.py`è‡ªåŠ¨å‘ç°æ¨¡å‹
- åˆ›å»ºåˆå§‹è¿ç§»ï¼ˆç©ºçš„ï¼Œä¸ºåç»­åšå‡†å¤‡ï¼‰

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆå§‹åŒ–Alembic: `alembic init alembic`
- [ ] å®Œå–„`backend/app/db/database.py`:
  - å¢åŠ è¿æ¥æ± é…ç½®
  - å¢åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥å‡½æ•°
  - å¢åŠ create_tables()å·¥å…·å‡½æ•°ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
- [ ] é…ç½®`alembic/env.py`:
  - å¯¼å…¥settingsè·å–DATABASE_URL
  - è‡ªåŠ¨å¯¼å…¥app.modelsä¸­çš„æ‰€æœ‰æ¨¡å‹
  - é…ç½®target_metadata = Base.metadata
- [ ] ä¿®æ”¹`alembic.ini`:
  - æ³¨é‡Šæ‰sqlalchemy.urlï¼ˆæ”¹ç”¨env.pyåŠ¨æ€è·å–ï¼‰
- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬æ¨¡æ¿
- [ ] æ·»åŠ æ•°æ®åº“åˆå§‹åŒ–æ–‡æ¡£åˆ°README

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `alembic/`ç›®å½•åŠé…ç½®
- ä¿®æ”¹: `app/db/database.py` (+50è¡Œ)
- ä¿®æ”¹: `alembic/env.py` (+30è¡Œ)
- æ–°å»º: `docs/DATABASE.md` (+100è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_database.py
def test_database_connection():
    """æµ‹è¯•æ•°æ®åº“è¿æ¥"""
    from app.db.database import engine
    with engine.connect() as conn:
        result = conn.execute(text("SELECT 1"))
        assert result.scalar() == 1

def test_get_db_dependency():
    """æµ‹è¯•æ•°æ®åº“ä¾èµ–æ³¨å…¥"""
    from app.db.database import get_db
    db = next(get_db())
    assert db is not None
    db.close()

def test_alembic_migration():
    """æµ‹è¯•Alembicè¿ç§»ç³»ç»Ÿ"""
    # è¿è¡Œ alembic upgrade head
    # éªŒè¯æ²¡æœ‰é”™è¯¯
```

**æ‰‹åŠ¨æµ‹è¯•**:
```bash
# 1. åˆå§‹åŒ–æ•°æ®åº“
cd backend
alembic upgrade head

# 2. æ£€æŸ¥æ•°æ®åº“è¡¨åˆ›å»ºï¼ˆå½“å‰åº”è¯¥ä¸ºç©ºï¼‰
# ä½¿ç”¨psqlæˆ–sqlite3æŸ¥çœ‹

# 3. æµ‹è¯•å›æ»š
alembic downgrade -1
alembic upgrade head

# 4. è¿è¡Œpytest
pytest tests/test_database.py -v
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] æ•°æ®åº“è¿æ¥æ± é…ç½®æ˜¯å¦åˆç†
- [ ] ä¸‰ç§æ•°æ®åº“ï¼ˆPostgreSQL/MySQL/SQLiteï¼‰æ˜¯å¦éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- [ ] Alembicè¿ç§»æ˜¯å¦èƒ½æ­£å¸¸æ‰§è¡Œ
- [ ] æµ‹è¯•æ˜¯å¦å…¨éƒ¨é€šè¿‡
- [ ] ä»£ç æ˜¯å¦ç¬¦åˆPEP 8è§„èŒƒï¼ˆè¿è¡Œblackå’Œflake8ï¼‰

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„æ•°æ®åº“æ¶æ„éƒ¨åˆ†ï¼Œç¡®ä¿ï¼š
- æ”¯æŒçš„æ•°æ®åº“ç±»å‹æ­£ç¡®
- è¿æ¥æ± é…ç½®åˆç†
- ç¬¦åˆFastAPIæœ€ä½³å®è·µ

#### 6. CommitèŠ‚ç‚¹

```bash
git add backend/alembic backend/alembic.ini backend/app/db/database.py tests/test_database.py
git commit -m "feat(backend): implement database infrastructure with Alembic

- Initialize Alembic migration system
- Enhance database.py with connection pool config
- Add database health check function
- Configure auto-discovery of models in alembic/env.py
- Add database tests
- Support PostgreSQL, MySQL, SQLite

Estimated lines: ~300
Status: âœ… All tests passing"
```

---

### Iteration 1.2: è®¤è¯ä¸æˆæƒç³»ç»Ÿ

**ç›®æ ‡**: å®ç°JWTè®¤è¯ã€ç”¨æˆ·æ³¨å†Œç™»å½•ã€æƒé™æ§åˆ¶

**ä»£ç é‡ä¼°ç®—**: ~800è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- JWT Tokenè®¤è¯ï¼ˆAccess Token 30åˆ†é’Ÿï¼ŒRefresh Token 7å¤©ï¼‰
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€é€€å‡ºã€åˆ·æ–°Token
- å¯†ç åŠ å¯†ï¼ˆbcryptï¼‰
- ä¾èµ–æ³¨å…¥è·å–å½“å‰ç”¨æˆ·
- åŸºäºç”¨æˆ·IDçš„æ•°æ®éš”ç¦»

**å®‰å…¨è¦æ±‚**:
- å¯†ç ä½¿ç”¨bcryptå“ˆå¸Œ
- Tokenç­¾åä½¿ç”¨HS256ç®—æ³•
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»æ›´æ”¹SECRET_KEY

#### 2. è®¾è®¡ (Design)

**æ–‡ä»¶ç»“æ„**:
```
backend/app/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ security.py            # æ–°å»º
â”‚   â””â”€â”€ dependencies.py        # æ–°å»º
â”œâ”€â”€ models/
â”‚   â””â”€â”€ user.py               # å·²å­˜åœ¨ï¼Œéœ€å®Œå–„
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ user.py               # å·²å­˜åœ¨ï¼Œéœ€å®Œå–„
â”‚   â””â”€â”€ token.py              # å·²å­˜åœ¨ï¼Œéœ€å®Œå–„
â”œâ”€â”€ services/
â”‚   â””â”€â”€ auth_service.py       # æ–°å»º
â””â”€â”€ api/v1/
    â”œâ”€â”€ auth.py               # å·²å­˜åœ¨ï¼Œéœ€å®ç°
    â””â”€â”€ users.py              # å·²å­˜åœ¨ï¼Œéœ€å®ç°
```

**æ ¸å¿ƒåŠŸèƒ½è®¾è®¡**:

1. **security.py**:
   - `hash_password(password: str) -> str`: å¯†ç å“ˆå¸Œ
   - `verify_password(plain, hashed) -> bool`: å¯†ç éªŒè¯
   - `create_access_token(data: dict) -> str`: ç”ŸæˆAccess Token
   - `create_refresh_token(data: dict) -> str`: ç”ŸæˆRefresh Token
   - `decode_token(token: str) -> dict`: è§£ç Token

2. **dependencies.py**:
   - `get_current_user(token: str, db: Session) -> User`: ä»Tokenè·å–å½“å‰ç”¨æˆ·
   - `get_current_active_user()`: è·å–æ¿€æ´»ç”¨æˆ·ï¼ˆæ’é™¤is_active=Falseï¼‰

3. **auth_service.py**:
   - `register_user(db, user_data) -> User`: æ³¨å†Œ
   - `authenticate_user(db, email, password) -> User | None`: è®¤è¯
   - `refresh_access_token(db, refresh_token) -> dict`: åˆ·æ–°Token

4. **APIè·¯ç”±**:
   - `POST /api/v1/auth/register`: æ³¨å†Œ
   - `POST /api/v1/auth/login`: ç™»å½•
   - `POST /api/v1/auth/refresh`: åˆ·æ–°Token
   - `GET /api/v1/users/me`: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] å®Œå–„`app/models/user.py`:
  - æ·»åŠ is_activeå­—æ®µ
  - æ·»åŠ created_at, updated_at
- [ ] å®ç°`app/core/security.py`:
  - å¯†ç å“ˆå¸Œå’ŒéªŒè¯
  - JWT Tokenç”Ÿæˆå’Œè§£ç 
- [ ] å®ç°`app/core/dependencies.py`:
  - get_current_userä¾èµ–
  - get_current_active_userä¾èµ–
- [ ] å®ç°`app/services/auth_service.py`:
  - ç”¨æˆ·æ³¨å†Œé€»è¾‘
  - ç”¨æˆ·è®¤è¯é€»è¾‘
  - Tokenåˆ·æ–°é€»è¾‘
- [ ] å®Œå–„`app/schemas/user.py`:
  - UserCreate, UserUpdate, UserInDB
- [ ] å®Œå–„`app/schemas/token.py`:
  - Token, TokenData
- [ ] å®ç°`app/api/v1/auth.py`:
  - æ³¨å†Œç«¯ç‚¹
  - ç™»å½•ç«¯ç‚¹
  - åˆ·æ–°Tokenç«¯ç‚¹
- [ ] å®ç°`app/api/v1/users.py`:
  - GET /meç«¯ç‚¹
- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»:
  - `alembic revision --autogenerate -m "add users table"`
  - `alembic upgrade head`

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/core/security.py` (~150è¡Œ)
- æ–°å»º: `app/core/dependencies.py` (~80è¡Œ)
- æ–°å»º: `app/services/auth_service.py` (~120è¡Œ)
- ä¿®æ”¹: `app/models/user.py` (+30è¡Œ)
- ä¿®æ”¹: `app/schemas/user.py` (+80è¡Œ)
- ä¿®æ”¹: `app/schemas/token.py` (+40è¡Œ)
- ä¿®æ”¹: `app/api/v1/auth.py` (~150è¡Œ)
- ä¿®æ”¹: `app/api/v1/users.py` (~80è¡Œ)
- æ–°å»º: `tests/test_auth.py` (~150è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_auth.py
def test_register_user(client):
    """æµ‹è¯•ç”¨æˆ·æ³¨å†Œ"""
    response = client.post("/api/v1/auth/register", json={
        "email": "test@example.com",
        "username": "testuser",
        "password": "password123"
    })
    assert response.status_code == 200
    assert "id" in response.json()

def test_login_success(client):
    """æµ‹è¯•ç™»å½•æˆåŠŸ"""
    # å…ˆæ³¨å†Œ
    client.post("/api/v1/auth/register", json={
        "email": "test@example.com",
        "username": "testuser",
        "password": "password123"
    })
    # ç™»å½•
    response = client.post("/api/v1/auth/login", json={
        "email": "test@example.com",
        "password": "password123"
    })
    assert response.status_code == 200
    assert "access_token" in response.json()
    assert "refresh_token" in response.json()

def test_login_wrong_password(client):
    """æµ‹è¯•å¯†ç é”™è¯¯"""
    response = client.post("/api/v1/auth/login", json={
        "email": "test@example.com",
        "password": "wrongpassword"
    })
    assert response.status_code == 401

def test_get_current_user(client):
    """æµ‹è¯•è·å–å½“å‰ç”¨æˆ·"""
    # æ³¨å†Œå¹¶ç™»å½•
    register_and_login(client)
    token = get_access_token(client)

    response = client.get("/api/v1/users/me", headers={
        "Authorization": f"Bearer {token}"
    })
    assert response.status_code == 200
    assert response.json()["email"] == "test@example.com"

def test_refresh_token(client):
    """æµ‹è¯•åˆ·æ–°Token"""
    # è·å–refresh_token
    refresh_token = get_refresh_token(client)

    response = client.post("/api/v1/auth/refresh", json={
        "refresh_token": refresh_token
    })
    assert response.status_code == 200
    assert "access_token" in response.json()
```

**æ‰‹åŠ¨æµ‹è¯•**:
```bash
# 1. å¯åŠ¨åç«¯
uvicorn app.main:app --reload

# 2. è®¿é—®Swagger UI
# http://localhost:8000/docs

# 3. æµ‹è¯•æ³¨å†Œ
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","username":"test","password":"pass123"}'

# 4. æµ‹è¯•ç™»å½•
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"pass123"}'

# 5. ä½¿ç”¨Tokenè®¿é—®å—ä¿æŠ¤ç«¯ç‚¹
curl http://localhost:8000/api/v1/users/me \
  -H "Authorization: Bearer <access_token>"
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] å¯†ç æ˜¯å¦ä½¿ç”¨bcryptæ­£ç¡®å“ˆå¸Œ
- [ ] JWT Tokenæ˜¯å¦åŒ…å«æ­£ç¡®çš„è¿‡æœŸæ—¶é—´
- [ ] Tokenåˆ·æ–°æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] æœªè®¤è¯ç”¨æˆ·è®¿é—®å—ä¿æŠ¤ç«¯ç‚¹æ˜¯å¦è¿”å›401
- [ ] æ‰€æœ‰æµ‹è¯•æ˜¯å¦é€šè¿‡
- [ ] ä»£ç æ˜¯å¦ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

**å®‰å…¨å®¡æŸ¥**:
- [ ] å¯†ç æ˜æ–‡æ˜¯å¦ä»å“åº”ä¸­æ’é™¤
- [ ] SECRET_KEYæ˜¯å¦ä»ç¯å¢ƒå˜é‡è¯»å–
- [ ] Tokenè¿‡æœŸæ—¶é—´æ˜¯å¦åˆç†
- [ ] æ˜¯å¦é˜²æ­¢äº†å¸¸è§çš„è®¤è¯æ¼æ´

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„å®‰å…¨æ¶æ„éƒ¨åˆ†ï¼Œç¡®è®¤ï¼š
- JWTé…ç½®ç¬¦åˆè®¾è®¡ï¼ˆAccess 30åˆ†é’Ÿï¼ŒRefresh 7å¤©ï¼‰
- å¯†ç åŠ å¯†æ–¹å¼æ­£ç¡®
- APIé‰´æƒæœºåˆ¶å®Œæ•´

#### 6. CommitèŠ‚ç‚¹

```bash
git add backend/app/core/security.py backend/app/core/dependencies.py \
  backend/app/services/auth_service.py backend/app/api/v1/auth.py \
  backend/app/api/v1/users.py backend/app/models/user.py \
  backend/app/schemas/ backend/alembic/versions/ tests/test_auth.py

git commit -m "feat(backend): implement JWT authentication system

- Add password hashing with bcrypt in security.py
- Implement JWT token generation and validation
- Add user registration and login endpoints
- Add current user dependency injection
- Add refresh token mechanism
- Create users table migration
- Add comprehensive auth tests

Security:
- Access token: 30 minutes
- Refresh token: 7 days
- Password: bcrypt hashed

Estimated lines: ~800
Status: âœ… All tests passing, security reviewed"
```

---

### Iteration 1.3: æ–‡ä»¶ä¸Šä¼ æœåŠ¡

**ç›®æ ‡**: å®ç°å›¾ç‰‡ä¸Šä¼ ã€å­˜å‚¨ã€è®¿é—®åŠŸèƒ½

**ä»£ç é‡ä¼°ç®—**: ~400è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- æ”¯æŒå›¾ç‰‡ä¸Šä¼ ï¼ˆJPG, PNGï¼‰
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼š10MB
- æŒ‰ç±»å‹åˆ†ç›®å½•å­˜å‚¨ï¼ˆnails/, inspirations/, designs/, actuals/ï¼‰
- è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼ˆé¿å…è¦†ç›–ï¼‰
- é€šè¿‡HTTPè®¿é—®å·²ä¸Šä¼ æ–‡ä»¶
- æ–‡ä»¶éªŒè¯ï¼ˆç±»å‹ã€å¤§å°ï¼‰

**å­˜å‚¨ç­–ç•¥**:
- MVPé˜¶æ®µï¼šæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆ`backend/uploads/`ï¼‰
- æœªæ¥ï¼šå¯è¿ç§»åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆé˜¿é‡Œäº‘OSS/è…¾è®¯äº‘COSï¼‰

#### 2. è®¾è®¡ (Design)

**æ–‡ä»¶ç»“æ„**:
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ file_storage.py    # æ–°å»º
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ file.py            # æ–°å»º
â”‚   â””â”€â”€ api/v1/
â”‚       â””â”€â”€ upload.py          # æ–°å»º
â”œâ”€â”€ uploads/                    # è¿è¡Œæ—¶åˆ›å»º
â”‚   â”œâ”€â”€ nails/
â”‚   â”œâ”€â”€ inspirations/
â”‚   â”œâ”€â”€ designs/
â”‚   â””â”€â”€ actuals/
```

**APIè®¾è®¡**:
- `POST /api/v1/upload`: é€šç”¨ä¸Šä¼ æ¥å£
  - Queryå‚æ•°: `file_type` (nail/inspiration/design/actual)
  - Body: multipart/form-data
  - Response: `{"file_path": "/uploads/nails/xxx.jpg", "url": "http://..."}`

**æ–‡ä»¶å‘½åè§„åˆ™**:
- æ ¼å¼: `{timestamp}_{random_string}_{original_name}.{ext}`
- ç¤ºä¾‹: `1704038400_a3f2d1_nail_photo.jpg`

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] å®ç°`app/core/file_storage.py`:
  - `validate_image_file(file)`: éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
  - `generate_unique_filename(original_name)`: ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
  - `save_upload_file(file, file_type)`: ä¿å­˜æ–‡ä»¶
  - `delete_file(file_path)`: åˆ é™¤æ–‡ä»¶ï¼ˆå·¥å…·å‡½æ•°ï¼‰
- [ ] åˆ›å»º`app/schemas/file.py`:
  - `FileUploadResponse`: ä¸Šä¼ å“åº”Schema
- [ ] å®ç°`app/api/v1/upload.py`:
  - ä¸Šä¼ ç«¯ç‚¹å®ç°
  - æ–‡ä»¶ç±»å‹éªŒè¯
  - é”™è¯¯å¤„ç†ï¼ˆæ–‡ä»¶è¿‡å¤§ã€æ ¼å¼é”™è¯¯ç­‰ï¼‰
- [ ] ä¿®æ”¹`app/main.py`:
  - æ·»åŠ é™æ€æ–‡ä»¶æœåŠ¡: `app.mount("/uploads", StaticFiles(directory="uploads"))`
- [ ] åœ¨`app/core/config.py`ä¸­æ·»åŠ é…ç½®:
  - `UPLOAD_DIR`, `MAX_UPLOAD_SIZE`, `ALLOWED_EXTENSIONS`
- [ ] åˆ›å»ºä¸Šä¼ ç›®å½•åˆå§‹åŒ–è„šæœ¬
- [ ] æ·»åŠ `.gitignore`å¿½ç•¥`uploads/*`ï¼ˆä¿ç•™ç›®å½•ç»“æ„ï¼‰

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/core/file_storage.py` (~150è¡Œ)
- æ–°å»º: `app/schemas/file.py` (~30è¡Œ)
- æ–°å»º: `app/api/v1/upload.py` (~100è¡Œ)
- ä¿®æ”¹: `app/main.py` (+10è¡Œ)
- ä¿®æ”¹: `app/core/config.py` (+15è¡Œ)
- ä¿®æ”¹: `.gitignore` (+5è¡Œ)
- æ–°å»º: `tests/test_upload.py` (~100è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_upload.py
def test_upload_image_success(client, auth_headers):
    """æµ‹è¯•ä¸Šä¼ å›¾ç‰‡æˆåŠŸ"""
    with open("tests/fixtures/test_image.jpg", "rb") as f:
        response = client.post(
            "/api/v1/upload?file_type=nail",
            files={"file": ("test.jpg", f, "image/jpeg")},
            headers=auth_headers
        )
    assert response.status_code == 200
    data = response.json()
    assert "file_path" in data
    assert "url" in data
    assert data["file_path"].startswith("/uploads/nails/")

def test_upload_file_too_large(client, auth_headers):
    """æµ‹è¯•æ–‡ä»¶è¿‡å¤§"""
    # åˆ›å»ºä¸€ä¸ªè¶…è¿‡10MBçš„æ–‡ä»¶
    large_file = b"x" * (11 * 1024 * 1024)
    response = client.post(
        "/api/v1/upload?file_type=nail",
        files={"file": ("large.jpg", large_file, "image/jpeg")},
        headers=auth_headers
    )
    assert response.status_code == 413  # Payload Too Large

def test_upload_invalid_type(client, auth_headers):
    """æµ‹è¯•æ— æ•ˆæ–‡ä»¶ç±»å‹"""
    response = client.post(
        "/api/v1/upload?file_type=nail",
        files={"file": ("test.txt", b"text content", "text/plain")},
        headers=auth_headers
    )
    assert response.status_code == 400

def test_access_uploaded_file(client, auth_headers):
    """æµ‹è¯•è®¿é—®ä¸Šä¼ çš„æ–‡ä»¶"""
    # å…ˆä¸Šä¼ 
    with open("tests/fixtures/test_image.jpg", "rb") as f:
        upload_response = client.post(
            "/api/v1/upload?file_type=nail",
            files={"file": ("test.jpg", f, "image/jpeg")},
            headers=auth_headers
        )
    file_path = upload_response.json()["file_path"]

    # è®¿é—®æ–‡ä»¶
    response = client.get(file_path)
    assert response.status_code == 200
    assert response.headers["content-type"].startswith("image/")
```

**æ‰‹åŠ¨æµ‹è¯•**:
```bash
# 1. å‡†å¤‡æµ‹è¯•å›¾ç‰‡
wget https://via.placeholder.com/500 -O test.jpg

# 2. ä¸Šä¼ å›¾ç‰‡
curl -X POST "http://localhost:8000/api/v1/upload?file_type=nail" \
  -H "Authorization: Bearer <token>" \
  -F "file=@test.jpg"

# 3. è®¿é—®ä¸Šä¼ çš„æ–‡ä»¶
# ä½¿ç”¨è¿”å›çš„URLåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€

# 4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®ä¿å­˜
ls -lh backend/uploads/nails/
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] æ–‡ä»¶ç±»å‹éªŒè¯æ˜¯å¦æ­£ç¡®
- [ ] æ–‡ä»¶å¤§å°é™åˆ¶æ˜¯å¦ç”Ÿæ•ˆ
- [ ] æ–‡ä»¶å‘½åæ˜¯å¦å”¯ä¸€ï¼ˆé¿å…è¦†ç›–ï¼‰
- [ ] å„ç±»å‹æ–‡ä»¶æ˜¯å¦ä¿å­˜åˆ°æ­£ç¡®ç›®å½•
- [ ] é™æ€æ–‡ä»¶æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] æ‰€æœ‰æµ‹è¯•æ˜¯å¦é€šè¿‡
- [ ] ä¸Šä¼ ç›®å½•æƒé™æ˜¯å¦æ­£ç¡®

**å®‰å…¨å®¡æŸ¥**:
- [ ] æ˜¯å¦éªŒè¯äº†æ–‡ä»¶MIMEç±»å‹
- [ ] æ˜¯å¦é™åˆ¶äº†æ–‡ä»¶æ‰©å±•å
- [ ] æ˜¯å¦é˜²æ­¢äº†è·¯å¾„éå†æ”»å‡»
- [ ] æ–‡ä»¶åæ˜¯å¦ç»è¿‡æ¸…ç†

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„æ–‡ä»¶å­˜å‚¨æ¶æ„ï¼Œç¡®è®¤ï¼š
- ç›®å½•ç»“æ„ç¬¦åˆè®¾è®¡
- æ–‡ä»¶å‘½åè§„åˆ™åˆç†
- é™æ€æ–‡ä»¶æœåŠ¡é…ç½®æ­£ç¡®

#### 6. CommitèŠ‚ç‚¹

```bash
git add backend/app/core/file_storage.py backend/app/schemas/file.py \
  backend/app/api/v1/upload.py backend/app/main.py \
  backend/app/core/config.py backend/.gitignore tests/test_upload.py

git commit -m "feat(backend): implement file upload service

- Add file validation (type, size) in file_storage.py
- Implement image upload endpoint at /api/v1/upload
- Add static file serving at /uploads
- Create directory structure: nails/, inspirations/, designs/, actuals/
- Add unique filename generation with timestamp
- File size limit: 10MB
- Allowed types: JPG, PNG
- Add comprehensive upload tests

Estimated lines: ~400
Status: âœ… All tests passing, security reviewed"
```

---

### Iteration 1.4: é”™è¯¯å¤„ç†ä¸æ—¥å¿—

**ç›®æ ‡**: ç»Ÿä¸€é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€å¼‚å¸¸ç®¡ç†

**ä»£ç é‡ä¼°ç®—**: ~350è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- ä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼ˆINFO, WARNING, ERRORï¼‰
- è¯·æ±‚/å“åº”æ—¥å¿—
- æ•°æ®åº“é”™è¯¯ã€AIé”™è¯¯çš„ç‰¹å®šå¤„ç†

**æ—¥å¿—éœ€æ±‚**:
- å¼€å‘ç¯å¢ƒï¼šæ§åˆ¶å°è¾“å‡º + æ–‡ä»¶
- ç”Ÿäº§ç¯å¢ƒï¼šæ–‡ä»¶è½®è½¬ï¼ˆæŒ‰æ—¥æœŸï¼‰
- å…³é”®æ“ä½œè®°å½•ï¼ˆç”¨æˆ·æ³¨å†Œã€AIè°ƒç”¨ã€æ–‡ä»¶ä¸Šä¼ ç­‰ï¼‰

#### 2. è®¾è®¡ (Design)

**æ–‡ä»¶ç»“æ„**:
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ exceptions.py      # æ–°å»º
â”‚   â”‚   â””â”€â”€ logging.py         # æ–°å»º
â”‚   â””â”€â”€ middleware/
â”‚       â””â”€â”€ logging.py         # æ–°å»º
â”œâ”€â”€ logs/                       # è¿è¡Œæ—¶åˆ›å»º
â”‚   â”œâ”€â”€ app.log
â”‚   â””â”€â”€ error.log
```

**è‡ªå®šä¹‰å¼‚å¸¸è®¾è®¡**:
```python
class NailAppException(Exception):
    """åŸºç¡€å¼‚å¸¸ç±»"""

class AuthenticationError(NailAppException):
    """è®¤è¯é”™è¯¯"""

class FileUploadError(NailAppException):
    """æ–‡ä»¶ä¸Šä¼ é”™è¯¯"""

class AIServiceError(NailAppException):
    """AIæœåŠ¡é”™è¯¯"""

class ResourceNotFoundError(NailAppException):
    """èµ„æºæœªæ‰¾åˆ°"""
```

**æ—¥å¿—ä¸­é—´ä»¶è®¾è®¡**:
- è®°å½•æ¯ä¸ªè¯·æ±‚çš„URLã€æ–¹æ³•ã€IPã€è€—æ—¶
- è®°å½•å“åº”çŠ¶æ€ç 
- é”™è¯¯æ—¶è®°å½•å®Œæ•´traceback

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] å®ç°`app/core/exceptions.py`:
  - è‡ªå®šä¹‰å¼‚å¸¸ç±»
  - å¼‚å¸¸åˆ°HTTPçŠ¶æ€ç çš„æ˜ å°„
- [ ] å®ç°`app/core/logging.py`:
  - é…ç½®æ—¥å¿—æ ¼å¼
  - é…ç½®æ—¥å¿—å¤„ç†å™¨ï¼ˆconsole + fileï¼‰
  - é…ç½®æ—¥å¿—è½®è½¬
- [ ] å®ç°`app/middleware/logging.py`:
  - è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
  - è®°å½•è¯·æ±‚è€—æ—¶
- [ ] ä¿®æ”¹`app/main.py`:
  - æ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†å™¨
  - æ³¨å†Œæ—¥å¿—ä¸­é—´ä»¶
- [ ] åœ¨å„æ¨¡å—ä¸­ä½¿ç”¨æ—¥å¿—:
  - auth_service.py: è®°å½•ç™»å½•/æ³¨å†Œ
  - file_storage.py: è®°å½•æ–‡ä»¶ä¸Šä¼ 
- [ ] åˆ›å»º`logs/`ç›®å½•ï¼ˆ.gitignoreï¼‰

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/core/exceptions.py` (~100è¡Œ)
- æ–°å»º: `app/core/logging.py` (~80è¡Œ)
- æ–°å»º: `app/middleware/logging.py` (~70è¡Œ)
- ä¿®æ”¹: `app/main.py` (+50è¡Œ)
- ä¿®æ”¹: `app/services/auth_service.py` (+20è¡Œï¼Œæ·»åŠ æ—¥å¿—)
- ä¿®æ”¹: `app/core/file_storage.py` (+15è¡Œï¼Œæ·»åŠ æ—¥å¿—)
- ä¿®æ”¹: `.gitignore` (+2è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_exceptions.py
def test_custom_exception_handler(client):
    """æµ‹è¯•è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†"""
    # è§¦å‘ResourceNotFoundError
    response = client.get("/api/v1/users/99999")
    assert response.status_code == 404
    assert "detail" in response.json()

def test_validation_error_handler(client):
    """æµ‹è¯•éªŒè¯é”™è¯¯å¤„ç†"""
    response = client.post("/api/v1/auth/register", json={
        "email": "invalid-email",  # æ— æ•ˆé‚®ç®±
        "password": "123"
    })
    assert response.status_code == 422

# tests/test_logging.py
def test_request_logging(client, caplog):
    """æµ‹è¯•è¯·æ±‚æ—¥å¿—"""
    with caplog.at_level(logging.INFO):
        client.get("/api/v1/health")

    # éªŒè¯æ—¥å¿—ä¸­åŒ…å«è¯·æ±‚ä¿¡æ¯
    assert "GET /api/v1/health" in caplog.text

def test_error_logging(client, caplog):
    """æµ‹è¯•é”™è¯¯æ—¥å¿—"""
    with caplog.at_level(logging.ERROR):
        client.get("/api/v1/users/invalid")

    # éªŒè¯é”™è¯¯è¢«è®°å½•
    assert "ERROR" in caplog.text
```

**æ‰‹åŠ¨æµ‹è¯•**:
```bash
# 1. å¯åŠ¨åº”ç”¨ï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡º
uvicorn app.main:app --reload

# 2. å‘èµ·æ­£å¸¸è¯·æ±‚
curl http://localhost:8000/api/v1/health

# 3. è§¦å‘é”™è¯¯
curl http://localhost:8000/api/v1/users/99999

# 4. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
tail -f backend/logs/app.log
tail -f backend/logs/error.log

# 5. éªŒè¯æ—¥å¿—è½®è½¬ï¼ˆç­‰å¾…æ—¥æœŸå˜åŒ–æˆ–æ‰‹åŠ¨ä¿®æ”¹æ—¥æœŸï¼‰
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] å¼‚å¸¸å¤„ç†æ˜¯å¦è¦†ç›–æ‰€æœ‰åœºæ™¯
- [ ] æ—¥å¿—æ ¼å¼æ˜¯å¦æ¸…æ™°æ˜“è¯»
- [ ] æ—¥å¿—çº§åˆ«ä½¿ç”¨æ˜¯å¦æ­£ç¡®
- [ ] æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€Tokenï¼‰æ˜¯å¦è¢«è¿‡æ»¤
- [ ] æ—¥å¿—æ–‡ä»¶æ˜¯å¦æ­£ç¡®è½®è½¬
- [ ] æ‰€æœ‰æµ‹è¯•æ˜¯å¦é€šè¿‡

**æ—¥å¿—å®¡æŸ¥**:
- [ ] æ˜¯å¦è®°å½•äº†è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- [ ] é”™è¯¯æ—¥å¿—æ˜¯å¦åŒ…å«traceback
- [ ] æ˜¯å¦é¿å…äº†æ—¥å¿—è¿‡å¤šå½±å“æ€§èƒ½

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„ç›‘æ§å’Œæ—¥å¿—éƒ¨åˆ†ï¼Œç¡®è®¤ï¼š
- æ—¥å¿—ç­–ç•¥ç¬¦åˆè®¾è®¡
- å…³é”®æ“ä½œå·²è®°å½•

#### 6. CommitèŠ‚ç‚¹

```bash
git add backend/app/core/exceptions.py backend/app/core/logging.py \
  backend/app/middleware/logging.py backend/app/main.py \
  backend/.gitignore tests/test_exceptions.py tests/test_logging.py

git commit -m "feat(backend): implement error handling and logging system

- Add custom exception classes (AuthenticationError, FileUploadError, etc.)
- Implement structured logging with file rotation
- Add request/response logging middleware
- Add global exception handlers
- Configure log levels (INFO, WARNING, ERROR)
- Add logging to auth and file upload services
- Filter sensitive data from logs

Estimated lines: ~350
Status: âœ… All tests passing"
```

---

### Iteration 1.5: APIæ–‡æ¡£ä¸å¥åº·æ£€æŸ¥

**ç›®æ ‡**: å®Œå–„APIæ–‡æ¡£ã€å¥åº·æ£€æŸ¥ã€ç³»ç»Ÿç›‘æ§ç«¯ç‚¹

**ä»£ç é‡ä¼°ç®—**: ~200è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- å®Œå–„Swagger UIæ–‡æ¡£
- æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆæ•°æ®åº“ã€Redisï¼‰
- æ·»åŠ ç³»ç»Ÿä¿¡æ¯ç«¯ç‚¹
- APIæ ‡ç­¾å’Œåˆ†ç»„
- Schemaç¤ºä¾‹æ•°æ®

#### 2. è®¾è®¡ (Design)

**APIç«¯ç‚¹è®¾è®¡**:
- `GET /health`: åŸºç¡€å¥åº·æ£€æŸ¥
- `GET /api/v1/health`: è¯¦ç»†å¥åº·æ£€æŸ¥ï¼ˆæ•°æ®åº“ã€Redisï¼‰
- `GET /api/v1/system/info`: ç³»ç»Ÿä¿¡æ¯ï¼ˆç‰ˆæœ¬ã€ç¯å¢ƒç­‰ï¼‰

**æ–‡æ¡£ä¼˜åŒ–**:
- æ·»åŠ APIæè¿°å’Œç¤ºä¾‹
- åˆ†ç»„æ ‡ç­¾ï¼ˆAuth, Users, Upload, etc.ï¼‰
- æ·»åŠ Schemaç¤ºä¾‹

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] å®Œå–„`app/api/v1/health.py`:
  - æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥
  - æ·»åŠ Rediså¥åº·æ£€æŸ¥ï¼ˆå¦‚æœå·²è¿æ¥ï¼‰
- [ ] æ–°å»º`app/api/v1/system.py`:
  - ç³»ç»Ÿä¿¡æ¯ç«¯ç‚¹
- [ ] ä¿®æ”¹`app/main.py`:
  - å®Œå–„FastAPIé…ç½®ï¼ˆtitle, description, versionï¼‰
  - æ·»åŠ tags_metadata
- [ ] åœ¨å„è·¯ç”±ä¸­æ·»åŠ è¯¦ç»†æ–‡æ¡£:
  - summary, description
  - response_model
  - ç¤ºä¾‹æ•°æ®
- [ ] æ·»åŠ OpenAPIè‡ªå®šä¹‰é…ç½®

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- ä¿®æ”¹: `app/api/v1/health.py` (+50è¡Œ)
- æ–°å»º: `app/api/v1/system.py` (~50è¡Œ)
- ä¿®æ”¹: `app/main.py` (+40è¡Œ)
- ä¿®æ”¹: å„APIè·¯ç”±æ–‡ä»¶ï¼ˆæ·»åŠ æ–‡æ¡£ï¼Œ+60è¡Œï¼‰

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_health.py
def test_health_check(client):
    """æµ‹è¯•å¥åº·æ£€æŸ¥"""
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

def test_detailed_health_check(client):
    """æµ‹è¯•è¯¦ç»†å¥åº·æ£€æŸ¥"""
    response = client.get("/api/v1/health")
    assert response.status_code == 200
    data = response.json()
    assert "database" in data
    assert "status" in data

def test_system_info(client):
    """æµ‹è¯•ç³»ç»Ÿä¿¡æ¯"""
    response = client.get("/api/v1/system/info")
    assert response.status_code == 200
    data = response.json()
    assert "version" in data
    assert "environment" in data
```

**æ‰‹åŠ¨æµ‹è¯•**:
```bash
# 1. è®¿é—®Swagger UI
open http://localhost:8000/docs

# 2. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/health
curl http://localhost:8000/api/v1/health

# 3. æµ‹è¯•ç³»ç»Ÿä¿¡æ¯
curl http://localhost:8000/api/v1/system/info

# 4. éªŒè¯APIæ–‡æ¡£å®Œæ•´æ€§
# åœ¨Swagger UIä¸­æµ‹è¯•å„ç«¯ç‚¹
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] å¥åº·æ£€æŸ¥æ˜¯å¦æ­£ç¡®åæ˜ ç³»ç»ŸçŠ¶æ€
- [ ] APIæ–‡æ¡£æ˜¯å¦æ¸…æ™°æ˜“æ‡‚
- [ ] Schemaç¤ºä¾‹æ˜¯å¦å‡†ç¡®
- [ ] æ‰€æœ‰æµ‹è¯•æ˜¯å¦é€šè¿‡

#### 6. CommitèŠ‚ç‚¹

```bash
git add backend/app/api/v1/health.py backend/app/api/v1/system.py \
  backend/app/main.py backend/app/api/v1/ tests/test_health.py

git commit -m "feat(backend): enhance API documentation and health checks

- Add detailed health check with database and Redis status
- Add system info endpoint
- Enhance Swagger UI with tags and descriptions
- Add schema examples for all models
- Improve API route documentation

Estimated lines: ~200
Status: âœ… All tests passing
ğŸ“ Stage 1 Complete: Framework Layer Done"
```

**ğŸ¯ é˜¶æ®µ1å®Œæˆæ£€æŸ¥ç‚¹**:
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] APIæ–‡æ¡£å®Œæ•´
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ‰§è¡Œ`black`å’Œ`flake8`ä»£ç æ ¼å¼åŒ–

**ğŸ’¾ å»ºè®®åœ¨æ­¤è¿›è¡ŒClaude Compact**: é˜¶æ®µ1å®Œæˆï¼Œå¯ä»¥æ•´ç†ä¸Šä¸‹æ–‡

---

## é˜¶æ®µ2: åŸºç¡€æ¨¡å— (Core Business Modules)

### Iteration 2.1: ç”¨æˆ·ç®¡ç†æ¨¡å—

**ç›®æ ‡**: å®Œå–„ç”¨æˆ·CRUDã€ä¸ªäººèµ„æ–™ç®¡ç†

**ä»£ç é‡ä¼°ç®—**: ~500è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- æ›´æ–°ç”¨æˆ·ä¸ªäººèµ„æ–™ï¼ˆç”¨æˆ·åã€é‚®ç®±ï¼‰
- ä¿®æ”¹å¯†ç 
- åˆ é™¤è´¦å·ï¼ˆè½¯åˆ é™¤ï¼Œè®¾ç½®is_active=Falseï¼‰
- ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼ŒPost-MVPï¼‰

**ä¸šåŠ¡è§„åˆ™**:
- ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
- ä¿®æ”¹é‚®ç®±éœ€éªŒè¯æ–°é‚®ç®±æœªè¢«ä½¿ç”¨
- ä¿®æ”¹å¯†ç éœ€éªŒè¯æ—§å¯†ç 

#### 2. è®¾è®¡ (Design)

**APIç«¯ç‚¹**:
- `GET /api/v1/users/me`: è·å–å½“å‰ç”¨æˆ·
- `PUT /api/v1/users/me`: æ›´æ–°å½“å‰ç”¨æˆ·
- `PUT /api/v1/users/me/password`: ä¿®æ”¹å¯†ç 
- `DELETE /api/v1/users/me`: åˆ é™¤è´¦å·

**Schemas**:
```python
class UserUpdate(BaseModel):
    username: str | None = None
    email: EmailStr | None = None

class PasswordChange(BaseModel):
    old_password: str
    new_password: str
```

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] å®Œå–„`app/services/user_service.py`:
  - `get_user_by_id(db, user_id)`
  - `update_user(db, user_id, update_data)`
  - `change_password(db, user_id, old_pwd, new_pwd)`
  - `deactivate_user(db, user_id)`
- [ ] å®Œå–„`app/schemas/user.py`:
  - UserUpdate, PasswordChange
- [ ] å®ç°`app/api/v1/users.py`:
  - GET /me
  - PUT /me
  - PUT /me/password
  - DELETE /me
- [ ] æ·»åŠ éªŒè¯é€»è¾‘ï¼ˆé‚®ç®±å”¯ä¸€æ€§ã€å¯†ç å¼ºåº¦ï¼‰

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/services/user_service.py` (~150è¡Œ)
- ä¿®æ”¹: `app/schemas/user.py` (+80è¡Œ)
- ä¿®æ”¹: `app/api/v1/users.py` (+150è¡Œ)
- æ–°å»º: `tests/test_users.py` (~120è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
def test_get_current_user(client, auth_headers):
    response = client.get("/api/v1/users/me", headers=auth_headers)
    assert response.status_code == 200

def test_update_user(client, auth_headers):
    response = client.put("/api/v1/users/me",
        headers=auth_headers,
        json={"username": "newname"})
    assert response.status_code == 200
    assert response.json()["username"] == "newname"

def test_change_password(client, auth_headers):
    response = client.put("/api/v1/users/me/password",
        headers=auth_headers,
        json={"old_password": "oldpass", "new_password": "newpass"})
    assert response.status_code == 200

def test_delete_user(client, auth_headers):
    response = client.delete("/api/v1/users/me", headers=auth_headers)
    assert response.status_code == 200
    # éªŒè¯ç”¨æˆ·is_active=False
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
- [ ] é‚®ç®±å”¯ä¸€æ€§éªŒè¯
- [ ] å¯†ç ä¿®æ”¹éœ€éªŒè¯æ—§å¯†ç 
- [ ] è½¯åˆ é™¤æ­£ç¡®å®ç°
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

#### 6. CommitèŠ‚ç‚¹

```bash
git commit -m "feat(backend): implement user management module

- Add user CRUD operations
- Add password change functionality
- Add soft delete for user accounts
- Add email uniqueness validation
- Add comprehensive user tests

Estimated lines: ~500
Status: âœ… All tests passing"
```

---

### Iteration 2.2: å®¢æˆ·æ¡£æ¡ˆç®¡ç†

**ç›®æ ‡**: å®ç°å®¢æˆ·åŸºç¡€æ¡£æ¡ˆçš„å¢åˆ æ”¹æŸ¥

**ä»£ç é‡ä¼°ç®—**: ~600è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- åˆ›å»ºå®¢æˆ·æ¡£æ¡ˆï¼ˆå§“åã€ç”µè¯ã€å¤‡æ³¨ï¼‰
- åˆ—å‡ºå½“å‰ç”¨æˆ·çš„æ‰€æœ‰å®¢æˆ·
- è·å–å®¢æˆ·è¯¦æƒ…
- æ›´æ–°å®¢æˆ·ä¿¡æ¯
- åˆ é™¤å®¢æˆ·ï¼ˆçº§è”åˆ é™¤æ‰€æœ‰å…³è”æ•°æ®ï¼‰

**æ•°æ®éš”ç¦»**:
- æ¯ä¸ªç¾ç”²å¸ˆåªèƒ½çœ‹åˆ°è‡ªå·±çš„å®¢æˆ·
- é€šè¿‡`user_id`å­—æ®µå®ç°æ•°æ®éš”ç¦»

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class Customer(Base):
    __tablename__ = "customers"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    name = Column(String(100), nullable=False)
    phone = Column(String(20))
    notes = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # å…³ç³»
    user = relationship("User", back_populates="customers")
```

**APIç«¯ç‚¹**:
- `POST /api/v1/customers`: åˆ›å»ºå®¢æˆ·
- `GET /api/v1/customers`: åˆ—å‡ºå®¢æˆ·ï¼ˆåˆ†é¡µã€æœç´¢ï¼‰
- `GET /api/v1/customers/{id}`: è·å–å®¢æˆ·è¯¦æƒ…
- `PUT /api/v1/customers/{id}`: æ›´æ–°å®¢æˆ·
- `DELETE /api/v1/customers/{id}`: åˆ é™¤å®¢æˆ·

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º`app/models/customer.py`:
  - Customeræ¨¡å‹
- [ ] åœ¨`app/models/__init__.py`ä¸­å¯¼å…¥Customer
- [ ] åˆ›å»º`app/schemas/customer.py`:
  - CustomerCreate, CustomerUpdate, CustomerResponse
- [ ] åˆ›å»º`app/services/customer_service.py`:
  - CRUDæ“ä½œ
  - æ•°æ®éš”ç¦»é€»è¾‘
  - åˆ†é¡µå’Œæœç´¢
- [ ] åˆ›å»º`app/api/v1/customers.py`:
  - æ‰€æœ‰CRUDç«¯ç‚¹
- [ ] åœ¨`app/api/v1/__init__.py`ä¸­æ³¨å†Œè·¯ç”±
- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»:
  - `alembic revision --autogenerate -m "add customers table"`
  - `alembic upgrade head`

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/customer.py` (~50è¡Œ)
- æ–°å»º: `app/schemas/customer.py` (~80è¡Œ)
- æ–°å»º: `app/services/customer_service.py` (~180è¡Œ)
- æ–°å»º: `app/api/v1/customers.py` (~150è¡Œ)
- ä¿®æ”¹: `app/models/__init__.py` (+2è¡Œ)
- ä¿®æ”¹: `app/api/v1/__init__.py` (+2è¡Œ)
- æ–°å»º: `tests/test_customers.py` (~140è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
def test_create_customer(client, auth_headers):
    response = client.post("/api/v1/customers",
        headers=auth_headers,
        json={"name": "å¼ ä¸‰", "phone": "13800138000"})
    assert response.status_code == 200
    assert response.json()["name"] == "å¼ ä¸‰"

def test_list_customers(client, auth_headers):
    # åˆ›å»ºå‡ ä¸ªå®¢æˆ·
    create_customers(client, auth_headers, count=3)

    response = client.get("/api/v1/customers", headers=auth_headers)
    assert response.status_code == 200
    assert len(response.json()["items"]) == 3

def test_get_customer(client, auth_headers):
    customer_id = create_customer(client, auth_headers)

    response = client.get(f"/api/v1/customers/{customer_id}",
        headers=auth_headers)
    assert response.status_code == 200

def test_update_customer(client, auth_headers):
    customer_id = create_customer(client, auth_headers)

    response = client.put(f"/api/v1/customers/{customer_id}",
        headers=auth_headers,
        json={"name": "æå››"})
    assert response.status_code == 200
    assert response.json()["name"] == "æå››"

def test_delete_customer(client, auth_headers):
    customer_id = create_customer(client, auth_headers)

    response = client.delete(f"/api/v1/customers/{customer_id}",
        headers=auth_headers)
    assert response.status_code == 200

def test_data_isolation(client, auth_headers_user1, auth_headers_user2):
    """æµ‹è¯•æ•°æ®éš”ç¦»ï¼šç”¨æˆ·2ä¸èƒ½è®¿é—®ç”¨æˆ·1çš„å®¢æˆ·"""
    customer_id = create_customer(client, auth_headers_user1)

    response = client.get(f"/api/v1/customers/{customer_id}",
        headers=auth_headers_user2)
    assert response.status_code == 404
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] æ•°æ®éš”ç¦»æ˜¯å¦æ­£ç¡®ï¼ˆç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„å®¢æˆ·ï¼‰
- [ ] åˆ†é¡µåŠŸèƒ½æ˜¯å¦æ­£å¸¸
- [ ] æœç´¢åŠŸèƒ½æ˜¯å¦å‡†ç¡®
- [ ] çº§è”åˆ é™¤æ˜¯å¦æ­£ç¡®é…ç½®
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„æ•°æ®åº“è®¾è®¡ï¼Œç¡®è®¤customersè¡¨ç»“æ„æ­£ç¡®ã€‚

#### 6. CommitèŠ‚ç‚¹

```bash
git commit -m "feat(backend): implement customer management module

- Add Customer model with user relationship
- Implement customer CRUD operations
- Add data isolation by user_id
- Add pagination and search
- Create customers table migration
- Add comprehensive customer tests

Estimated lines: ~600
Status: âœ… All tests passing, data isolation verified"
```

---

### Iteration 2.3: å®¢æˆ·è¯¦ç»†æ¡£æ¡ˆ

**ç›®æ ‡**: å®ç°å®¢æˆ·è¯¦ç»†æ¡£æ¡ˆï¼ˆç”²å‹ç‰¹å¾ã€åå¥½ã€ç¦å¿Œï¼‰

**ä»£ç é‡ä¼°ç®—**: ~700è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- å®¢æˆ·è¯¦ç»†æ¡£æ¡ˆï¼ˆä¸€å¯¹ä¸€å…³ç³»ï¼‰
- ç”²å‹ç‰¹å¾ï¼ˆå½¢çŠ¶ã€å¤§å°ã€çŠ¶æ€ï¼‰
- é¢œè‰²åå¥½ã€é£æ ¼åå¥½ï¼ˆJSONæ•°ç»„ï¼‰
- ç¦å¿Œäº‹é¡¹ï¼ˆJSONæ•°ç»„ï¼‰
- æ¡£æ¡ˆç…§ç‰‡ï¼ˆå¤šå¼ ï¼ŒJSONæ•°ç»„ï¼‰

**ä¸šåŠ¡è§„åˆ™**:
- ä¸€ä¸ªå®¢æˆ·åªæœ‰ä¸€ä¸ªè¯¦ç»†æ¡£æ¡ˆ
- æ¡£æ¡ˆå¯ä»¥åœ¨åˆ›å»ºå®¢æˆ·æ—¶ä¸€èµ·åˆ›å»ºï¼Œä¹Ÿå¯ä»¥åç»­åˆ›å»º
- æ¡£æ¡ˆæ›´æ–°ä¼šè¦†ç›–æ—§æ•°æ®ï¼ˆéå¢é‡ï¼‰

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class CustomerProfile(Base):
    __tablename__ = "customer_profiles"

    id = Column(Integer, primary_key=True, index=True)
    customer_id = Column(Integer, ForeignKey("customers.id", ondelete="CASCADE"),
                         unique=True, nullable=False)
    nail_shape = Column(String(50))  # almond, square, oval, etc.
    nail_size = Column(String(20))   # small, medium, large
    nail_condition = Column(String(50))  # healthy, brittle, etc.
    color_preferences = Column(JSON)  # ["#FF69B4", "#FFB6C1"]
    style_preferences = Column(JSON)  # ["minimalist", "elegant"]
    prohibitions = Column(JSON)       # ["glitter", "long"]
    profile_images = Column(JSON)     # ["/uploads/nails/xxx.jpg"]
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    customer = relationship("Customer", back_populates="profile")
```

**APIç«¯ç‚¹**:
- `POST /api/v1/customers/{customer_id}/profile`: åˆ›å»º/æ›´æ–°æ¡£æ¡ˆ
- `GET /api/v1/customers/{customer_id}/profile`: è·å–æ¡£æ¡ˆ
- `DELETE /api/v1/customers/{customer_id}/profile`: åˆ é™¤æ¡£æ¡ˆ

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º`app/models/customer_profile.py`
- [ ] ä¿®æ”¹`app/models/customer.py`:
  - æ·»åŠ profile relationship
- [ ] åˆ›å»º`app/schemas/customer_profile.py`:
  - ProfileCreate, ProfileUpdate, ProfileResponse
- [ ] åˆ›å»º`app/services/customer_profile_service.py`:
  - create_or_update_profile
  - get_profile
  - delete_profile
- [ ] åˆ›å»º`app/api/v1/customer_profiles.py`:
  - åµŒå¥—åœ¨customersè·¯ç”±ä¸‹
- [ ] ä¿®æ”¹customers APIä»¥åŒ…å«profileä¿¡æ¯
- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»
- [ ] ä¸Šä¼ æ¡£æ¡ˆç…§ç‰‡çš„é›†æˆ

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/customer_profile.py` (~60è¡Œ)
- ä¿®æ”¹: `app/models/customer.py` (+10è¡Œ)
- æ–°å»º: `app/schemas/customer_profile.py` (~120è¡Œ)
- æ–°å»º: `app/services/customer_profile_service.py` (~150è¡Œ)
- æ–°å»º: `app/api/v1/customer_profiles.py` (~120è¡Œ)
- ä¿®æ”¹: `app/schemas/customer.py` (+40è¡Œï¼Œæ·»åŠ profileå­—æ®µ)
- ä¿®æ”¹: `app/api/v1/__init__.py` (+2è¡Œ)
- æ–°å»º: `tests/test_customer_profiles.py` (~200è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
def test_create_profile(client, auth_headers, customer_id):
    response = client.post(f"/api/v1/customers/{customer_id}/profile",
        headers=auth_headers,
        json={
            "nail_shape": "almond",
            "nail_size": "medium",
            "color_preferences": ["#FF69B4", "#FFB6C1"],
            "style_preferences": ["minimalist", "elegant"],
            "prohibitions": ["glitter"]
        })
    assert response.status_code == 200
    assert response.json()["nail_shape"] == "almond"

def test_get_profile(client, auth_headers, customer_id):
    create_profile(client, auth_headers, customer_id)

    response = client.get(f"/api/v1/customers/{customer_id}/profile",
        headers=auth_headers)
    assert response.status_code == 200
    assert "color_preferences" in response.json()

def test_update_profile(client, auth_headers, customer_id):
    create_profile(client, auth_headers, customer_id)

    response = client.post(f"/api/v1/customers/{customer_id}/profile",
        headers=auth_headers,
        json={"nail_shape": "square"})
    assert response.status_code == 200
    assert response.json()["nail_shape"] == "square"

def test_get_customer_with_profile(client, auth_headers, customer_id):
    create_profile(client, auth_headers, customer_id)

    response = client.get(f"/api/v1/customers/{customer_id}",
        headers=auth_headers)
    assert response.status_code == 200
    assert response.json()["profile"] is not None
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] JSONå­—æ®µæ˜¯å¦æ­£ç¡®å­˜å‚¨å’Œæ£€ç´¢
- [ ] ä¸€å¯¹ä¸€å…³ç³»æ˜¯å¦æ­£ç¡®
- [ ] çº§è”åˆ é™¤æ˜¯å¦å·¥ä½œï¼ˆåˆ é™¤å®¢æˆ·æ—¶è‡ªåŠ¨åˆ é™¤æ¡£æ¡ˆï¼‰
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„customer_profilesè¡¨è®¾è®¡ï¼Œç¡®è®¤å­—æ®µå®Œæ•´ã€‚

#### 6. CommitèŠ‚ç‚¹

```bash
git commit -m "feat(backend): implement customer profile management

- Add CustomerProfile model with one-to-one relationship
- Implement profile CRUD operations
- Add JSON fields for preferences and prohibitions
- Support nail characteristics (shape, size, condition)
- Add profile to customer response
- Create customer_profiles table migration
- Add comprehensive profile tests

Estimated lines: ~700
Status: âœ… All tests passing
ğŸ“ Stage 2 Complete: Basic Modules Done"
```

**ğŸ¯ é˜¶æ®µ2å®Œæˆæ£€æŸ¥ç‚¹**:
- [ ] ç”¨æˆ·ç®¡ç†æ¨¡å—æµ‹è¯•é€šè¿‡
- [ ] å®¢æˆ·ç®¡ç†æ¨¡å—æµ‹è¯•é€šè¿‡
- [ ] å®¢æˆ·æ¡£æ¡ˆæ¨¡å—æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®éš”ç¦»æ­£ç¡®å®ç°
- [ ] APIæ–‡æ¡£æ›´æ–°

**ğŸ’¾ å»ºè®®åœ¨æ­¤è¿›è¡ŒClaude Compact**: é˜¶æ®µ2å®Œæˆï¼Œå¯ä»¥æ•´ç†ä¸Šä¸‹æ–‡

---

## é˜¶æ®µ3: AIæŠ½è±¡å±‚ (AI Provider Layer)

### Iteration 3.1: AI ProvideræŠ½è±¡æ¥å£

**ç›®æ ‡**: å®šä¹‰AIæœåŠ¡æŠ½è±¡æ¥å£å’Œå·¥å‚æ¨¡å¼

**ä»£ç é‡ä¼°ç®—**: ~400è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- å®šä¹‰ç»Ÿä¸€çš„AIæœåŠ¡æ¥å£
- æ”¯æŒå¤šç§AI Providerï¼ˆOpenAIã€Baiduç­‰ï¼‰
- å·¥å‚æ¨¡å¼åˆ›å»ºProviderå®ä¾‹
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- å“åº”ç¼“å­˜ï¼ˆRedisï¼‰

**æ ¸å¿ƒæ–¹æ³•**:
1. `generate_design()`: ç”Ÿæˆè®¾è®¡å›¾
2. `refine_design()`: å¾®è°ƒè®¾è®¡
3. `estimate_execution()`: è¯„ä¼°è€—æ—¶å’Œç”¨æ–™
4. `compare_images()`: å¯¹æ¯”åˆ†æ

#### 2. è®¾è®¡ (Design)

**æ–‡ä»¶ç»“æ„**:
```
backend/app/services/ai/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ base.py              # æŠ½è±¡åŸºç±»
â”œâ”€â”€ factory.py           # å·¥å‚ç±»
â”œâ”€â”€ exceptions.py        # AIç›¸å…³å¼‚å¸¸
â””â”€â”€ cache.py             # ç¼“å­˜ç­–ç•¥
```

**æŠ½è±¡æ¥å£è®¾è®¡**:
```python
from abc import ABC, abstractmethod
from typing import List, Dict

class AIProvider(ABC):
    @abstractmethod
    async def generate_design(
        self,
        prompt: str,
        reference_images: List[str],
        design_target: str = "single",
        **kwargs
    ) -> str:
        """ç”Ÿæˆè®¾è®¡å›¾ï¼Œè¿”å›å›¾ç‰‡URL"""
        pass

    @abstractmethod
    async def refine_design(
        self,
        original_image: str,
        refinement_instruction: str,
        **kwargs
    ) -> str:
        """å¾®è°ƒè®¾è®¡ï¼Œè¿”å›æ–°å›¾ç‰‡URL"""
        pass

    @abstractmethod
    async def estimate_execution(
        self,
        design_image: str
    ) -> Dict:
        """è¯„ä¼°è®¾è®¡è½åœ°ä¿¡æ¯"""
        pass

    @abstractmethod
    async def compare_images(
        self,
        design_image: str,
        actual_image: str
    ) -> Dict:
        """å¯¹æ¯”ä¸¤å¼ å›¾ç‰‡"""
        pass
```

**å·¥å‚æ¨¡å¼**:
```python
class AIProviderFactory:
    _instances = {}

    @classmethod
    def get_provider(cls, provider_type: str = None) -> AIProvider:
        if provider_type is None:
            provider_type = settings.AI_PROVIDER

        if provider_type not in cls._instances:
            if provider_type == "openai":
                cls._instances[provider_type] = OpenAIProvider(...)
            elif provider_type == "baidu":
                raise NotImplementedError("Baidu provider not implemented")
            else:
                raise ValueError(f"Unknown provider: {provider_type}")

        return cls._instances[provider_type]
```

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º`app/services/ai/__init__.py`
- [ ] å®ç°`app/services/ai/base.py`:
  - AIProvideræŠ½è±¡åŸºç±»
  - æ–¹æ³•ç­¾åå’Œæ–‡æ¡£å­—ç¬¦ä¸²
- [ ] å®ç°`app/services/ai/exceptions.py`:
  - AIProviderError
  - AIGenerationError
  - AIAnalysisError
- [ ] å®ç°`app/services/ai/factory.py`:
  - AIProviderFactory
  - å•ä¾‹æ¨¡å¼ç¼“å­˜
- [ ] å®ç°`app/services/ai/cache.py`:
  - AIå“åº”ç¼“å­˜ç­–ç•¥
  - Redisé›†æˆ
- [ ] åœ¨`app/core/config.py`æ·»åŠ é…ç½®:
  - AI_PROVIDER
  - AI_CACHE_TTL
- [ ] åˆ›å»ºAIç›¸å…³schemas:
  - `app/schemas/ai.py`

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/services/ai/__init__.py` (~20è¡Œ)
- æ–°å»º: `app/services/ai/base.py` (~150è¡Œ)
- æ–°å»º: `app/services/ai/exceptions.py` (~40è¡Œ)
- æ–°å»º: `app/services/ai/factory.py` (~80è¡Œ)
- æ–°å»º: `app/services/ai/cache.py` (~100è¡Œ)
- ä¿®æ”¹: `app/core/config.py` (+15è¡Œ)
- æ–°å»º: `tests/test_ai_factory.py` (~80è¡Œ)

#### 4. æµ‹è¯• (Testing)

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_ai_factory.py
def test_factory_creates_provider():
    """æµ‹è¯•å·¥å‚åˆ›å»ºProvider"""
    from app.services.ai.factory import AIProviderFactory

    # æ³¨æ„ï¼šè¿™ä¸ªæµ‹è¯•ä¼šåœ¨OpenAIå®ç°åæ‰èƒ½çœŸæ­£é€šè¿‡
    # ç°åœ¨æµ‹è¯•å·¥å‚é€»è¾‘
    factory = AIProviderFactory()
    # éªŒè¯å·¥å‚æ–¹æ³•å­˜åœ¨
    assert hasattr(factory, 'get_provider')

def test_factory_singleton():
    """æµ‹è¯•å•ä¾‹æ¨¡å¼"""
    from app.services.ai.factory import AIProviderFactory

    provider1 = AIProviderFactory.get_provider("openai")
    provider2 = AIProviderFactory.get_provider("openai")

    assert provider1 is provider2  # åŒä¸€å®ä¾‹

def test_ai_exceptions():
    """æµ‹è¯•AIå¼‚å¸¸"""
    from app.services.ai.exceptions import AIProviderError

    with pytest.raises(AIProviderError):
        raise AIProviderError("Test error")

# tests/test_ai_cache.py
def test_cache_set_get(redis_client):
    """æµ‹è¯•ç¼“å­˜å­˜å–"""
    from app.services.ai.cache import AICache

    cache = AICache(redis_client)
    cache.set("test_prompt", {"result": "test"})

    result = cache.get("test_prompt")
    assert result["result"] == "test"

def test_cache_expiry(redis_client):
    """æµ‹è¯•ç¼“å­˜è¿‡æœŸ"""
    from app.services.ai.cache import AICache
    import time

    cache = AICache(redis_client, ttl=1)
    cache.set("test", {"data": "value"})

    time.sleep(2)
    result = cache.get("test")
    assert result is None
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] æŠ½è±¡æ¥å£æ˜¯å¦æ¸…æ™°æ˜ç¡®
- [ ] å·¥å‚æ¨¡å¼æ˜¯å¦æ­£ç¡®å®ç°
- [ ] å¼‚å¸¸ç±»å‹æ˜¯å¦åˆç†
- [ ] ç¼“å­˜ç­–ç•¥æ˜¯å¦æ­£ç¡®
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„AI Provideræ¶æ„è®¾è®¡ï¼Œç¡®è®¤ï¼š
- æ¥å£æ–¹æ³•å®Œæ•´
- å·¥å‚æ¨¡å¼ç¬¦åˆè®¾è®¡
- å¯æ‰©å±•æ€§æ»¡è¶³è¦æ±‚

#### 6. CommitèŠ‚ç‚¹

```bash
git commit -m "feat(backend): implement AI provider abstraction layer

- Add AIProvider abstract base class
- Define interface methods (generate_design, refine_design, etc.)
- Implement AIProviderFactory with singleton pattern
- Add AI-specific exceptions
- Add Redis-based caching for AI responses
- Add AI configuration in settings

Design pattern: Abstract Factory + Strategy
Estimated lines: ~400
Status: âœ… Framework ready for provider implementations"
```

---

### Iteration 3.2: OpenAI Providerå®ç°

**ç›®æ ‡**: å®ç°OpenAI Providerï¼ˆDALL-E 3 + GPT-4 Visionï¼‰

**ä»£ç é‡ä¼°ç®—**: ~900è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- ä½¿ç”¨DALL-E 3ç”Ÿæˆè®¾è®¡å›¾
- ä½¿ç”¨GPT-4 Visionè¿›è¡Œå›¾åƒåˆ†æ
- å®ç°è®¾è®¡å¾®è°ƒï¼ˆVisionåˆ†æ + DALL-Eé‡æ–°ç”Ÿæˆï¼‰
- å®ç°è€—æ—¶å’Œç”¨æ–™è¯„ä¼°
- å®ç°å›¾åƒå¯¹æ¯”åˆ†æ

**OpenAI API**:
- DALL-E 3: `client.images.generate()`
- GPT-4 Vision: `client.chat.completions.create()` with image_url

#### 2. è®¾è®¡ (Design)

**æ–‡ä»¶ç»“æ„**:
```
backend/app/services/ai/
â””â”€â”€ openai_provider.py   # OpenAIå®ç°
```

**Promptè®¾è®¡ç­–ç•¥**:
- è®¾è®¡ç”Ÿæˆï¼šç»“åˆå®¢æˆ·åå¥½ç”Ÿæˆè¯¦ç»†prompt
- å¾®è°ƒï¼šå…ˆç”¨Visionåˆ†æï¼Œå†ç”Ÿæˆæ–°prompt
- è¯„ä¼°ï¼šä½¿ç”¨ç»“æ„åŒ–promptè¦æ±‚JSONè¾“å‡º
- å¯¹æ¯”ï¼šåŒæ—¶ä¼ å…¥ä¸¤å¼ å›¾ç‰‡è¿›è¡Œåˆ†æ

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º`app/services/ai/openai_provider.py`:
  - ç»§æ‰¿AIProvider
  - å®ç°æ‰€æœ‰æŠ½è±¡æ–¹æ³•
- [ ] å®ç°`generate_design()`:
  - æ ¹æ®design_targetè°ƒæ•´prompt
  - è°ƒç”¨DALL-E 3
  - ä¸‹è½½å¹¶ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°
  - è¿”å›æœ¬åœ°è·¯å¾„
- [ ] å®ç°`refine_design()`:
  - ä½¿ç”¨GPT-4 Visionåˆ†æåŸå›¾
  - åº”ç”¨refinement_instruction
  - ç”Ÿæˆæ–°prompt
  - è°ƒç”¨DALL-E 3
- [ ] å®ç°`estimate_execution()`:
  - ä½¿ç”¨GPT-4 Visionåˆ†æè®¾è®¡
  - æå–è€—æ—¶ã€ææ–™ã€å¤æ‚åº¦
  - è¿”å›ç»“æ„åŒ–æ•°æ®
- [ ] å®ç°`compare_images()`:
  - åŒæ—¶ä¼ å…¥è®¾è®¡å›¾å’Œå®é™…å›¾
  - åˆ†æç›¸ä¼¼åº¦ã€å·®å¼‚ã€å»ºè®®
  - æå–èƒ½åŠ›è¯„åˆ†
- [ ] æ·»åŠ å·¥å…·æ–¹æ³•:
  - `_build_prompt()`: æ„å»ºprompt
  - `_download_image()`: ä¸‹è½½å›¾ç‰‡
  - `_parse_json_response()`: è§£æJSON
- [ ] åœ¨`app/core/config.py`æ·»åŠ :
  - OPENAI_API_KEY
  - OPENAI_MODEL_TEXT
  - OPENAI_MODEL_IMAGE
- [ ] æ·»åŠ requirements:
  - openai>=1.0.0

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/services/ai/openai_provider.py` (~600è¡Œ)
- ä¿®æ”¹: `app/core/config.py` (+10è¡Œ)
- ä¿®æ”¹: `backend/requirements.txt` (+1è¡Œ)
- æ–°å»º: `tests/test_openai_provider.py` (~250è¡Œ)
- æ–°å»º: `tests/fixtures/` (æµ‹è¯•å›¾ç‰‡)

#### 4. æµ‹è¯• (Testing)

**é‡è¦**: OpenAI APIæµ‹è¯•éœ€è¦çœŸå®API Keyï¼Œå»ºè®®ä½¿ç”¨Mock

**æµ‹è¯•ç­–ç•¥**:
1. **Mockæµ‹è¯•**ï¼ˆé»˜è®¤ï¼‰ï¼šæ¨¡æ‹ŸOpenAIå“åº”
2. **é›†æˆæµ‹è¯•**ï¼ˆå¯é€‰ï¼‰ï¼šä½¿ç”¨çœŸå®API Keyï¼Œæ ‡è®°ä¸º`@pytest.mark.integration`

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_openai_provider.py
import pytest
from unittest.mock import AsyncMock, patch

@pytest.fixture
def mock_openai_client():
    """Mock OpenAI client"""
    with patch('openai.AsyncOpenAI') as mock:
        yield mock

def test_generate_design_single_nail(mock_openai_client):
    """æµ‹è¯•ç”Ÿæˆå•æŒ‡è®¾è®¡"""
    from app.services.ai.openai_provider import OpenAIProvider

    # Mock DALL-E response
    mock_openai_client.return_value.images.generate = AsyncMock(
        return_value=Mock(data=[Mock(url="https://example.com/image.jpg")])
    )

    provider = OpenAIProvider(api_key="test")
    result = await provider.generate_design(
        prompt="Pink floral nail art",
        reference_images=[],
        design_target="single"
    )

    assert result.startswith("/uploads/designs/")

def test_refine_design(mock_openai_client):
    """æµ‹è¯•å¾®è°ƒè®¾è®¡"""
    # Mock GPT-4 Vision response
    mock_openai_client.return_value.chat.completions.create = AsyncMock(
        return_value=Mock(
            choices=[Mock(message=Mock(content="Refined prompt here"))]
        )
    )

    provider = OpenAIProvider(api_key="test")
    result = await provider.refine_design(
        original_image="/uploads/designs/original.jpg",
        refinement_instruction="Make it brighter"
    )

    assert result.startswith("/uploads/designs/")

def test_estimate_execution(mock_openai_client):
    """æµ‹è¯•è¯„ä¼°è€—æ—¶"""
    mock_response = {
        "duration_min": 90,
        "duration_max": 120,
        "materials": [{"name": "Pink polish", "amount": "medium"}],
        "complexity": "medium"
    }

    mock_openai_client.return_value.chat.completions.create = AsyncMock(
        return_value=Mock(
            choices=[Mock(message=Mock(content=json.dumps(mock_response)))]
        )
    )

    provider = OpenAIProvider(api_key="test")
    result = await provider.estimate_execution("/uploads/designs/test.jpg")

    assert result["duration_min"] == 90
    assert result["complexity"] == "medium"

def test_compare_images(mock_openai_client):
    """æµ‹è¯•å›¾åƒå¯¹æ¯”"""
    mock_response = {
        "similarity_score": 85,
        "differences": {"color": "Slightly lighter"},
        "suggestions": ["Pay attention to color accuracy"]
    }

    provider = OpenAIProvider(api_key="test")
    result = await provider.compare_images(
        design_image="/uploads/designs/design.jpg",
        actual_image="/uploads/actuals/actual.jpg"
    )

    assert result["similarity_score"] == 85

@pytest.mark.integration
@pytest.mark.skip(reason="Requires real OpenAI API key")
def test_real_api_call():
    """é›†æˆæµ‹è¯•ï¼šçœŸå®APIè°ƒç”¨"""
    import os
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        pytest.skip("OPENAI_API_KEY not set")

    provider = OpenAIProvider(api_key=api_key)
    result = await provider.generate_design(
        prompt="Simple pink nail art",
        reference_images=[],
        design_target="single"
    )

    assert os.path.exists(result)
```

**æ‰‹åŠ¨æµ‹è¯•** (éœ€è¦çœŸå®API Key):
```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export OPENAI_API_KEY=sk-your-api-key

# 2. å¯åŠ¨Python REPL
cd backend
python

# 3. æµ‹è¯•ç”Ÿæˆè®¾è®¡
from app.services.ai.factory import AIProviderFactory
import asyncio

async def test():
    provider = AIProviderFactory.get_provider("openai")
    result = await provider.generate_design(
        prompt="Elegant pink floral nail art",
        reference_images=[],
        design_target="single"
    )
    print(f"Generated: {result}")

asyncio.run(test())

# 4. æ£€æŸ¥ç”Ÿæˆçš„å›¾ç‰‡
ls -lh backend/uploads/designs/
```

#### 5. æ ¡å¯¹ä¸ä¿®æ­£ (Review & Fix)

**æ£€æŸ¥é¡¹**:
- [ ] æ‰€æœ‰æŠ½è±¡æ–¹æ³•æ˜¯å¦æ­£ç¡®å®ç°
- [ ] Promptæ˜¯å¦æ¸…æ™°æœ‰æ•ˆ
- [ ] å›¾ç‰‡ä¸‹è½½å’Œä¿å­˜æ˜¯å¦æ­£ç¡®
- [ ] JSONè§£ææ˜¯å¦å¥å£®
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„
- [ ] APIè°ƒç”¨æ˜¯å¦ç¬¦åˆOpenAIæœ€ä½³å®è·µ
- [ ] æˆæœ¬æ§åˆ¶ï¼ˆprompté•¿åº¦ã€å›¾ç‰‡è´¨é‡ï¼‰

**æˆæœ¬ä¼˜åŒ–**:
- [ ] ä½¿ç”¨standardè´¨é‡è€Œéhdï¼ˆèŠ‚çœæˆæœ¬ï¼‰
- [ ] Promptå°½é‡ç²¾ç®€
- [ ] åˆ©ç”¨ç¼“å­˜é¿å…é‡å¤è°ƒç”¨

**ä¸åŸå§‹è®¾è®¡å¯¹æ¯”**:
å‚è€ƒ`docs/ARCHITECTURE.md`ä¸­çš„OpenAI Providerè®¾è®¡ï¼Œç¡®è®¤ï¼š
- æ‰€æœ‰æ–¹æ³•å®ç°ç¬¦åˆæ¥å£
- Promptç­–ç•¥åˆç†
- é”™è¯¯å¤„ç†å®Œæ•´

#### 6. CommitèŠ‚ç‚¹

```bash
git commit -m "feat(backend): implement OpenAI provider for AI services

- Implement OpenAIProvider class inheriting AIProvider
- Add DALL-E 3 integration for design generation
- Add GPT-4 Vision integration for image analysis
- Implement design refinement workflow
- Implement execution estimation (time and materials)
- Implement image comparison with similarity scoring
- Add image download and local storage
- Add comprehensive mock tests
- Add integration test markers for real API calls

APIs used:
- DALL-E 3: Image generation
- GPT-4 Vision: Image analysis

Estimated lines: ~900
Status: âœ… All mock tests passing
âš ï¸ Integration tests require OPENAI_API_KEY
ğŸ“ Stage 3 Complete: AI Layer Ready"
```

**ğŸ¯ é˜¶æ®µ3å®Œæˆæ£€æŸ¥ç‚¹**:
- [ ] AIæŠ½è±¡å±‚æµ‹è¯•é€šè¿‡
- [ ] OpenAI Providerå®ç°å®Œæ•´
- [ ] Mockæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] ï¼ˆå¯é€‰ï¼‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] APIæˆæœ¬è¯„ä¼°å®Œæˆ

**ğŸ’¾ å»ºè®®åœ¨æ­¤è¿›è¡ŒClaude Compact**: é˜¶æ®µ3å®Œæˆï¼ŒAIå±‚å·²å°±ç»ª

---

## é˜¶æ®µ4: æ ¸å¿ƒä¸šåŠ¡æ¨¡å— (Core Business Features)

### Iteration 4.1: çµæ„Ÿå›¾åº“ç®¡ç†

**ç›®æ ‡**: å®ç°çµæ„Ÿå›¾ä¸Šä¼ ã€æ ‡ç­¾ç®¡ç†ã€æ£€ç´¢åŠŸèƒ½

**ä»£ç é‡ä¼°ç®—**: ~550è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- ä¸Šä¼ çµæ„Ÿå›¾ç‰‡
- ä¸ºå›¾ç‰‡æ·»åŠ æ ‡ç­¾ï¼ˆé£æ ¼ã€é¢œè‰²ã€å­£èŠ‚ç­‰ï¼‰
- æŒ‰æ ‡ç­¾æ£€ç´¢å›¾ç‰‡
- åˆ é™¤å›¾ç‰‡
- åˆ—å‡ºæ‰€æœ‰çµæ„Ÿå›¾ï¼ˆåˆ†é¡µï¼‰

**ä¸šåŠ¡è§„åˆ™**:
- çµæ„Ÿå›¾å±äºç¾ç”²å¸ˆä¸ªäºº
- æ”¯æŒæ‰¹é‡ä¸Šä¼ 
- æ ‡ç­¾å¯ä»¥è‡ªç”±æ·»åŠ 

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class InspirationImage(Base):
    __tablename__ = "inspiration_images"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    image_path = Column(String(500), nullable=False)
    tags = Column(JSON)  # ["floral", "pink", "spring"]
    created_at = Column(DateTime, default=datetime.utcnow)

    user = relationship("User", back_populates="inspiration_images")
```

**APIç«¯ç‚¹**:
- `POST /api/v1/inspirations`: ä¸Šä¼ çµæ„Ÿå›¾
- `GET /api/v1/inspirations`: åˆ—å‡ºçµæ„Ÿå›¾ï¼ˆåˆ†é¡µã€æ ‡ç­¾ç­›é€‰ï¼‰
- `GET /api/v1/inspirations/{id}`: è·å–çµæ„Ÿå›¾è¯¦æƒ…
- `PUT /api/v1/inspirations/{id}`: æ›´æ–°æ ‡ç­¾
- `DELETE /api/v1/inspirations/{id}`: åˆ é™¤çµæ„Ÿå›¾

#### 3-6. å®ç°ã€æµ‹è¯•ã€æ ¡å¯¹ã€Commit

ï¼ˆè¯¦ç»†æ­¥éª¤çœç•¥ï¼Œå‚è€ƒå‰é¢çš„æ¨¡å¼ï¼‰

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/inspiration_image.py` (~40è¡Œ)
- æ–°å»º: `app/schemas/inspiration.py` (~80è¡Œ)
- æ–°å»º: `app/services/inspiration_service.py` (~150è¡Œ)
- æ–°å»º: `app/api/v1/inspirations.py` (~150è¡Œ)
- æ–°å»º: `tests/test_inspirations.py` (~130è¡Œ)

**CommitèŠ‚ç‚¹**:
```bash
git commit -m "feat(backend): implement inspiration image gallery

- Add InspirationImage model
- Implement image upload with tagging
- Add tag-based search and filtering
- Add pagination for image listing
- Create inspiration_images table migration

Estimated lines: ~550
Status: âœ… All tests passing"
```

---

### Iteration 4.2: AIè®¾è®¡æ–¹æ¡ˆç”Ÿæˆ

**ç›®æ ‡**: å®ç°AIè®¾è®¡æ–¹æ¡ˆç”ŸæˆåŠŸèƒ½

**ä»£ç é‡ä¼°ç®—**: ~800è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- åŸºäºå®¢æˆ·æ¡£æ¡ˆç”Ÿæˆè®¾è®¡æ–¹æ¡ˆ
- ç»“åˆçµæ„Ÿå›¾ä½œä¸ºå‚è€ƒ
- æ”¯æŒè‡ªå®šä¹‰æç¤ºè¯
- é€‰æ‹©ç”Ÿæˆç›®æ ‡ï¼ˆ1æŒ‡/5æŒ‡/10æŒ‡ï¼‰
- è‡ªåŠ¨è¯„ä¼°è€—æ—¶å’Œç”¨æ–™
- ä¿å­˜è®¾è®¡æ–¹æ¡ˆ

**AI Promptæ„å»ºç­–ç•¥**:
```
åŸºç¡€Prompt = å®¢æˆ·åå¥½ï¼ˆé¢œè‰²ã€é£æ ¼ï¼‰ + ç”²å‹ç‰¹å¾ + å‚è€ƒå›¾æè¿°
æœ€ç»ˆPrompt = åŸºç¡€Prompt + ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯ + ç”Ÿæˆç›®æ ‡æè¿°
```

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class DesignPlan(Base):
    __tablename__ = "design_plans"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    customer_id = Column(Integer, ForeignKey("customers.id"))
    inspiration_image_ids = Column(JSON)  # [1, 2, 3]
    ai_prompt = Column(Text)  # è‡ªåŠ¨ç”Ÿæˆçš„prompt
    custom_prompt = Column(Text)  # ç”¨æˆ·è‡ªå®šä¹‰
    design_target = Column(String(20), default="single")
    generated_image_path = Column(String(500))
    design_description = Column(Text)
    estimated_duration_min = Column(Integer)
    estimated_duration_max = Column(Integer)
    material_list = Column(JSON)
    version = Column(Integer, default=1)
    created_at = Column(DateTime, default=datetime.utcnow)
```

**APIç«¯ç‚¹**:
- `POST /api/v1/designs/generate`: ç”Ÿæˆè®¾è®¡æ–¹æ¡ˆ

#### 3. å®ç° (Implementation)

**æ ¸å¿ƒé€»è¾‘**:
```python
# app/services/design_service.py
class DesignService:
    @staticmethod
    async def generate_design_plan(
        db: Session,
        user_id: int,
        customer_id: int,
        inspiration_image_ids: List[int],
        custom_prompt: str = "",
        design_target: str = "single"
    ):
        # 1. è·å–å®¢æˆ·æ¡£æ¡ˆ
        customer = get_customer_with_profile(db, customer_id, user_id)

        # 2. æ„å»ºAI Prompt
        ai_prompt = build_prompt_from_profile(customer.profile)
        full_prompt = f"{ai_prompt}\n{custom_prompt}" if custom_prompt else ai_prompt

        # 3. è·å–çµæ„Ÿå›¾è·¯å¾„
        inspiration_images = get_inspiration_images(db, inspiration_image_ids, user_id)
        image_paths = [img.image_path for img in inspiration_images]

        # 4. è°ƒç”¨AIç”Ÿæˆè®¾è®¡
        ai_provider = AIProviderFactory.get_provider()
        design_image_path = await ai_provider.generate_design(
            prompt=full_prompt,
            reference_images=image_paths,
            design_target=design_target
        )

        # 5. è¯„ä¼°è€—æ—¶å’Œç”¨æ–™
        estimation = await ai_provider.estimate_execution(design_image_path)

        # 6. ä¿å­˜è®¾è®¡æ–¹æ¡ˆ
        design_plan = DesignPlan(
            user_id=user_id,
            customer_id=customer_id,
            inspiration_image_ids=inspiration_image_ids,
            ai_prompt=ai_prompt,
            custom_prompt=custom_prompt,
            design_target=design_target,
            generated_image_path=design_image_path,
            estimated_duration_min=estimation["duration_min"],
            estimated_duration_max=estimation["duration_max"],
            material_list=estimation["materials"]
        )
        db.add(design_plan)
        db.commit()
        db.refresh(design_plan)

        return design_plan
```

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/design_plan.py` (~80è¡Œ)
- æ–°å»º: `app/schemas/design.py` (~150è¡Œ)
- æ–°å»º: `app/services/design_service.py` (~300è¡Œ)
- æ–°å»º: `app/api/v1/designs.py` (~150è¡Œ)
- æ–°å»º: `tests/test_designs.py` (~120è¡Œ)

**CommitèŠ‚ç‚¹**:
```bash
git commit -m "feat(backend): implement AI design generation

- Add DesignPlan model
- Implement prompt building from customer profile
- Integrate AI provider for design generation
- Add automatic execution estimation
- Support custom prompts and design targets
- Create design_plans table migration

Estimated lines: ~800
Status: âœ… All tests passing (with AI mocks)"
```

---

### Iteration 4.3: è®¾è®¡æ–¹æ¡ˆå¾®è°ƒ

**ç›®æ ‡**: å®ç°åŸºäºç°æœ‰è®¾è®¡çš„å¾®è°ƒåŠŸèƒ½

**ä»£ç é‡ä¼°ç®—**: ~500è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- é€‰æ‹©å·²æœ‰è®¾è®¡æ–¹æ¡ˆ
- è¾“å…¥å¾®è°ƒæŒ‡ä»¤ï¼ˆå¦‚"é¢œè‰²è°ƒäº®"ã€"å¢åŠ é‡‘ç®”"ï¼‰
- AIåˆ†æåŸè®¾è®¡å¹¶åº”ç”¨å¾®è°ƒ
- ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬ï¼Œå…³è”åˆ°åŸè®¾è®¡ï¼ˆparent_design_idï¼‰
- ä¿ç•™å¾®è°ƒå†å²

**ç‰ˆæœ¬ç®¡ç†**:
- æ¯æ¬¡å¾®è°ƒåˆ›å»ºæ–°è®°å½•
- parent_design_idæŒ‡å‘åŸè®¾è®¡
- versionå­—æ®µé€’å¢

#### 2. è®¾è®¡ (Design)

**APIç«¯ç‚¹**:
- `POST /api/v1/designs/{id}/refine`: å¾®è°ƒè®¾è®¡

**å·¥ä½œæµç¨‹**:
```
1. è·å–åŸè®¾è®¡å›¾ç‰‡
2. è°ƒç”¨AI Providerçš„refine_design()
3. ç”Ÿæˆæ–°è®¾è®¡å›¾ç‰‡
4. åˆ›å»ºæ–°DesignPlanè®°å½•ï¼ˆparent_design_id = åŸè®¾è®¡IDï¼‰
5. version = parent.version + 1
6. è¿”å›æ–°è®¾è®¡æ–¹æ¡ˆ
```

#### 3-6. å®ç°ã€æµ‹è¯•ã€æ ¡å¯¹ã€Commit

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- ä¿®æ”¹: `app/models/design_plan.py` (+10è¡Œï¼Œæ·»åŠ parent_design_id)
- ä¿®æ”¹: `app/services/design_service.py` (+150è¡Œ)
- ä¿®æ”¹: `app/api/v1/designs.py` (+80è¡Œ)
- æ–°å»º: `tests/test_design_refinement.py` (~100è¡Œ)

**CommitèŠ‚ç‚¹**:
```bash
git commit -m "feat(backend): implement design refinement feature

- Add parent_design_id for version tracking
- Implement design refinement workflow
- Add version history support
- Integrate AI refine_design() method
- Add refinement tests

Estimated lines: ~500
Status: âœ… All tests passing"
```

---

### Iteration 4.4: æœåŠ¡è®°å½•ç®¡ç†

**ç›®æ ‡**: å®ç°æœåŠ¡è®°å½•çš„åˆ›å»ºã€å®Œæˆã€æŸ¥è¯¢

**ä»£ç é‡ä¼°ç®—**: ~600è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- åˆ›å»ºæœåŠ¡è®°å½•ï¼ˆå…³è”å®¢æˆ·ã€è®¾è®¡æ–¹æ¡ˆï¼‰
- è®°å½•æœåŠ¡æ—¥æœŸå’Œå®é™…è€—æ—¶
- ä¸Šä¼ å®é™…å®Œæˆå›¾
- æ›´æ–°æœåŠ¡çŠ¶æ€ï¼ˆpending â†’ completedï¼‰
- åˆ—å‡ºå†å²æœåŠ¡è®°å½•

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class ServiceRecord(Base):
    __tablename__ = "service_records"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    customer_id = Column(Integer, ForeignKey("customers.id"))
    design_plan_id = Column(Integer, ForeignKey("design_plans.id"))
    service_date = Column(Date, nullable=False)
    service_duration = Column(Integer)  # åˆ†é’Ÿ
    actual_image_path = Column(String(500))
    notes = Column(Text)
    status = Column(String(20), default="pending")
    created_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
```

**APIç«¯ç‚¹**:
- `POST /api/v1/services`: åˆ›å»ºæœåŠ¡è®°å½•
- `GET /api/v1/services`: åˆ—å‡ºæœåŠ¡è®°å½•
- `GET /api/v1/services/{id}`: è·å–æœåŠ¡è¯¦æƒ…
- `PUT /api/v1/services/{id}/complete`: å®ŒæˆæœåŠ¡ï¼ˆä¸Šä¼ å®é™…å›¾ï¼‰
- `PUT /api/v1/services/{id}`: æ›´æ–°æœåŠ¡è®°å½•

#### 3-6. å®ç°ã€æµ‹è¯•ã€æ ¡å¯¹ã€Commit

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/service_record.py` (~60è¡Œ)
- æ–°å»º: `app/schemas/service.py` (~120è¡Œ)
- æ–°å»º: `app/services/service_record_service.py` (~180è¡Œ)
- æ–°å»º: `app/api/v1/services.py` (~150è¡Œ)
- æ–°å»º: `tests/test_services.py` (~140è¡Œ)

**CommitèŠ‚ç‚¹**:
```bash
git commit -m "feat(backend): implement service record management

- Add ServiceRecord model
- Implement service CRUD operations
- Add service completion workflow
- Support actual image upload
- Create service_records table migration

Estimated lines: ~600
Status: âœ… All tests passing"
```

---

### Iteration 4.5: AIå¯¹æ¯”åˆ†æ

**ç›®æ ‡**: å®ç°è®¾è®¡å›¾ä¸å®é™…å›¾çš„AIå¯¹æ¯”åˆ†æ

**ä»£ç é‡ä¼°ç®—**: ~700è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- å½“æœåŠ¡å®Œæˆå¹¶ä¸Šä¼ å®é™…å›¾æ—¶ï¼Œè‡ªåŠ¨è§¦å‘AIå¯¹æ¯”
- AIåˆ†æä¸¤å¼ å›¾ç‰‡çš„ç›¸ä¼¼åº¦å’Œå·®å¼‚
- æå–æ”¹è¿›å»ºè®®
- ä¿å­˜å¯¹æ¯”ç»“æœ
- ç”¨äºåç»­èƒ½åŠ›åˆ†æ

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class ComparisonResult(Base):
    __tablename__ = "comparison_results"

    id = Column(Integer, primary_key=True, index=True)
    service_record_id = Column(Integer, ForeignKey("service_records.id"), unique=True)
    similarity_score = Column(Integer)  # 0-100
    differences = Column(JSON)  # {"color": "...", "pattern": "..."}
    suggestions = Column(JSON)  # ["...", "..."]
    analyzed_at = Column(DateTime, default=datetime.utcnow)
```

**è§¦å‘æ—¶æœº**:
- æœåŠ¡çŠ¶æ€å˜ä¸ºcompletedæ—¶è‡ªåŠ¨è§¦å‘
- ä¹Ÿå¯ä»¥æ‰‹åŠ¨é‡æ–°åˆ†æ

**APIç«¯ç‚¹**:
- `POST /api/v1/services/{id}/analyze`: è§¦å‘å¯¹æ¯”åˆ†æ
- `GET /api/v1/services/{id}/comparison`: è·å–å¯¹æ¯”ç»“æœ

#### 3. å®ç° (Implementation)

**æ ¸å¿ƒé€»è¾‘**:
```python
# app/services/analysis_service.py
class AnalysisService:
    @staticmethod
    async def analyze_service(db: Session, service_id: int, user_id: int):
        # 1. è·å–æœåŠ¡è®°å½•
        service = get_service_record(db, service_id, user_id)

        # 2. éªŒè¯æœ‰è®¾è®¡å›¾å’Œå®é™…å›¾
        if not service.design_plan or not service.actual_image_path:
            raise ValueError("Missing design or actual image")

        # 3. è°ƒç”¨AIå¯¹æ¯”
        ai_provider = AIProviderFactory.get_provider()
        comparison = await ai_provider.compare_images(
            design_image=service.design_plan.generated_image_path,
            actual_image=service.actual_image_path
        )

        # 4. ä¿å­˜å¯¹æ¯”ç»“æœ
        result = ComparisonResult(
            service_record_id=service_id,
            similarity_score=comparison["similarity_score"],
            differences=comparison["differences"],
            suggestions=comparison["suggestions"]
        )
        db.add(result)
        db.commit()

        # 5. è§¦å‘èƒ½åŠ›è¯„åˆ†æ›´æ–°ï¼ˆä¸‹ä¸€ä¸ªè¿­ä»£ï¼‰
        # await update_ability_scores(db, user_id, service_id, comparison)

        return result
```

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/comparison_result.py` (~50è¡Œ)
- æ–°å»º: `app/schemas/analysis.py` (~100è¡Œ)
- æ–°å»º: `app/services/analysis_service.py` (~200è¡Œ)
- ä¿®æ”¹: `app/api/v1/services.py` (+100è¡Œ)
- æ–°å»º: `tests/test_analysis.py` (~150è¡Œ)

**CommitèŠ‚ç‚¹**:
```bash
git commit -m "feat(backend): implement AI comparison analysis

- Add ComparisonResult model
- Implement AI-powered image comparison
- Add automatic analysis on service completion
- Extract similarity scores and differences
- Generate improvement suggestions
- Create comparison_results table migration

Estimated lines: ~700
Status: âœ… All tests passing (with AI mocks)"
```

---

### Iteration 4.6: èƒ½åŠ›ç»´åº¦ç®¡ç†

**ç›®æ ‡**: å®ç°èƒ½åŠ›ç»´åº¦å®šä¹‰å’Œåˆå§‹åŒ–

**ä»£ç é‡ä¼°ç®—**: ~400è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- é¢„å®šä¹‰èƒ½åŠ›ç»´åº¦ï¼ˆé¢œè‰²æ­é…ã€å›¾æ¡ˆç²¾åº¦ã€ç»†èŠ‚å¤„ç†ç­‰ï¼‰
- ç®¡ç†ç»´åº¦æƒé‡
- æ”¯æŒè‡ªå®šä¹‰ç»´åº¦ï¼ˆPost-MVPï¼‰

**é¢„å®šä¹‰ç»´åº¦**:
1. é¢œè‰²æ­é… (Color Matching)
2. å›¾æ¡ˆç²¾åº¦ (Pattern Precision)
3. ç»†èŠ‚å¤„ç† (Detail Work)
4. æ•´ä½“æ„å›¾ (Overall Composition)
5. æŠ€æ³•è¿ç”¨ (Technique Application)
6. åˆ›æ„è¡¨è¾¾ (Creative Expression)

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class AbilityDimension(Base):
    __tablename__ = "ability_dimensions"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), unique=True, nullable=False)
    description = Column(Text)
    weight = Column(Numeric(3, 2), default=1.0)
    created_at = Column(DateTime, default=datetime.utcnow)
```

**åˆå§‹åŒ–æ•°æ®**:
```python
INITIAL_DIMENSIONS = [
    {"name": "é¢œè‰²æ­é…", "description": "è‰²å½©ç»„åˆçš„åè°ƒæ€§å’Œåˆ›æ„", "weight": 1.0},
    {"name": "å›¾æ¡ˆç²¾åº¦", "description": "å›¾æ¡ˆç»˜åˆ¶çš„ç²¾ç¡®åº¦å’Œç»†è…»åº¦", "weight": 1.0},
    {"name": "ç»†èŠ‚å¤„ç†", "description": "ç»†èŠ‚çš„å®Œæ•´åº¦å’Œç²¾è‡´åº¦", "weight": 1.0},
    {"name": "æ•´ä½“æ„å›¾", "description": "è®¾è®¡çš„æ•´ä½“ç¾æ„Ÿå’Œå¹³è¡¡", "weight": 1.0},
    {"name": "æŠ€æ³•è¿ç”¨", "description": "ç¾ç”²æŠ€æ³•çš„ç†Ÿç»ƒåº¦å’Œå¤šæ ·æ€§", "weight": 1.0},
    {"name": "åˆ›æ„è¡¨è¾¾", "description": "è®¾è®¡çš„åˆ›æ–°æ€§å’Œç‹¬ç‰¹æ€§", "weight": 1.0},
]
```

**APIç«¯ç‚¹**:
- `GET /api/v1/abilities/dimensions`: åˆ—å‡ºæ‰€æœ‰ç»´åº¦
- `POST /api/v1/abilities/dimensions/init`: åˆå§‹åŒ–ç»´åº¦ï¼ˆä»…ç®¡ç†å‘˜ï¼‰

#### 3-6. å®ç°ã€æµ‹è¯•ã€æ ¡å¯¹ã€Commit

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/ability_dimension.py` (~40è¡Œ)
- æ–°å»º: `app/schemas/ability.py` (~80è¡Œ)
- æ–°å»º: `app/services/ability_service.py` (~100è¡Œ)
- æ–°å»º: `app/api/v1/abilities.py` (~80è¡Œ)
- æ–°å»º: `alembic/versions/xxx_init_ability_dimensions.py` (æ•°æ®è¿ç§»)
- æ–°å»º: `tests/test_abilities.py` (~100è¡Œ)

**CommitèŠ‚ç‚¹**:
```bash
git commit -m "feat(backend): implement ability dimension system

- Add AbilityDimension model
- Define 6 core ability dimensions
- Add dimension initialization migration
- Add dimension listing API
- Create ability_dimensions table with initial data

Estimated lines: ~400
Status: âœ… All tests passing"
```

---

### Iteration 4.7: èƒ½åŠ›åˆ†æä¸å¯è§†åŒ–æ•°æ®

**ç›®æ ‡**: å®ç°èƒ½åŠ›è¯„åˆ†è®°å½•å’Œç»Ÿè®¡åˆ†æ

**ä»£ç é‡ä¼°ç®—**: ~850è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- ä»AIå¯¹æ¯”ç»“æœä¸­æå–èƒ½åŠ›è¯„åˆ†
- ä¿å­˜æ¯æ¬¡æœåŠ¡çš„èƒ½åŠ›è¯„åˆ†
- è®¡ç®—å„ç»´åº¦çš„å¹³å‡åˆ†
- æä¾›èƒ½åŠ›é›·è¾¾å›¾æ•°æ®
- è¯†åˆ«æ“…é•¿å’Œå¾…æå‡é¢†åŸŸ

**è¯„åˆ†æå–ç­–ç•¥**:
- AIå¯¹æ¯”æ—¶è¦æ±‚è¿”å›å„ç»´åº¦è¯„åˆ†
- ä¿®æ”¹`compare_images()`çš„å“åº”æ ¼å¼ï¼Œå¢åŠ ability_scores

#### 2. è®¾è®¡ (Design)

**æ•°æ®åº“æ¨¡å‹**:
```python
class AbilityRecord(Base):
    __tablename__ = "ability_records"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    service_record_id = Column(Integer, ForeignKey("service_records.id"))
    dimension_id = Column(Integer, ForeignKey("ability_dimensions.id"))
    score = Column(Integer)  # 0-100
    evidence = Column(JSON)  # è¯„åˆ†ä¾æ®
    recorded_at = Column(DateTime, default=datetime.utcnow)
```

**APIç«¯ç‚¹**:
- `GET /api/v1/abilities/stats`: è·å–èƒ½åŠ›ç»Ÿè®¡ï¼ˆé›·è¾¾å›¾æ•°æ®ï¼‰
- `GET /api/v1/abilities/history`: è·å–èƒ½åŠ›æˆé•¿æ›²çº¿æ•°æ®
- `GET /api/v1/abilities/summary`: è·å–æ“…é•¿/å¾…æå‡æ€»ç»“

#### 3. å®ç° (Implementation)

**æ ¸å¿ƒé€»è¾‘**:
```python
# app/services/ability_service.py (ç»­)
class AbilityService:
    @staticmethod
    async def record_abilities_from_comparison(
        db: Session,
        user_id: int,
        service_id: int,
        comparison_result: dict
    ):
        """ä»å¯¹æ¯”ç»“æœä¸­æå–å¹¶è®°å½•èƒ½åŠ›è¯„åˆ†"""
        ability_scores = comparison_result.get("ability_scores", {})

        for dimension_name, score_data in ability_scores.items():
            dimension = get_dimension_by_name(db, dimension_name)
            if not dimension:
                continue

            record = AbilityRecord(
                user_id=user_id,
                service_record_id=service_id,
                dimension_id=dimension.id,
                score=score_data["score"],
                evidence=score_data.get("evidence", {})
            )
            db.add(record)

        db.commit()

    @staticmethod
    def get_ability_stats(db: Session, user_id: int) -> Dict:
        """è·å–èƒ½åŠ›é›·è¾¾å›¾æ•°æ®"""
        dimensions = db.query(AbilityDimension).all()
        stats = {}

        for dim in dimensions:
            avg_score = db.query(func.avg(AbilityRecord.score))\
                .filter(
                    AbilityRecord.user_id == user_id,
                    AbilityRecord.dimension_id == dim.id
                )\
                .scalar()

            stats[dim.name] = {
                "score": round(avg_score or 0, 1),
                "count": get_record_count(db, user_id, dim.id)
            }

        return stats

    @staticmethod
    def get_ability_summary(db: Session, user_id: int) -> Dict:
        """è·å–æ“…é•¿å’Œå¾…æå‡æ€»ç»“"""
        stats = AbilityService.get_ability_stats(db, user_id)

        sorted_by_score = sorted(stats.items(), key=lambda x: x[1]["score"], reverse=True)

        return {
            "strengths": sorted_by_score[:3],  # å‰3å
            "improvements": sorted_by_score[-3:],  # å3å
        }
```

**ä¿®æ”¹AI Provider**:
```python
# app/services/ai/openai_provider.py
async def compare_images(self, design_image: str, actual_image: str) -> Dict:
    """å¢å¼ºç‰ˆå¯¹æ¯”åˆ†æï¼ŒåŒ…å«èƒ½åŠ›è¯„åˆ†"""
    prompt = """
    Compare these two nail art images (design vs actual result).

    Provide analysis in JSON format:
    {
        "similarity_score": 0-100,
        "differences": {
            "color": "description",
            "pattern": "description",
            ...
        },
        "suggestions": ["...", "..."],
        "ability_scores": {
            "é¢œè‰²æ­é…": {"score": 0-100, "evidence": "..."},
            "å›¾æ¡ˆç²¾åº¦": {"score": 0-100, "evidence": "..."},
            "ç»†èŠ‚å¤„ç†": {"score": 0-100, "evidence": "..."},
            "æ•´ä½“æ„å›¾": {"score": 0-100, "evidence": "..."},
            "æŠ€æ³•è¿ç”¨": {"score": 0-100, "evidence": "..."},
            "åˆ›æ„è¡¨è¾¾": {"score": 0-100, "evidence": "..."}
        }
    }
    """
    # ... AIè°ƒç”¨
```

**é¢„æœŸæ–‡ä»¶æ”¹åŠ¨**:
- æ–°å»º: `app/models/ability_record.py` (~50è¡Œ)
- ä¿®æ”¹: `app/schemas/ability.py` (+100è¡Œ)
- ä¿®æ”¹: `app/services/ability_service.py` (+300è¡Œ)
- ä¿®æ”¹: `app/services/analysis_service.py` (+50è¡Œï¼Œé›†æˆèƒ½åŠ›è®°å½•)
- ä¿®æ”¹: `app/services/ai/openai_provider.py` (+50è¡Œï¼Œä¿®æ”¹prompt)
- ä¿®æ”¹: `app/api/v1/abilities.py` (+150è¡Œ)
- æ–°å»º: `tests/test_ability_analysis.py` (~150è¡Œ)

**CommitèŠ‚ç‚¹**:
```bash
git commit -m "feat(backend): implement ability tracking and analysis

- Add AbilityRecord model for tracking scores
- Extract ability scores from AI comparison
- Implement ability statistics calculation
- Add radar chart data endpoint
- Add ability growth history endpoint
- Add strengths/improvements summary
- Enhance AI comparison prompt with ability scoring
- Create ability_records table migration

Estimated lines: ~850
Status: âœ… All tests passing
ğŸ“ Stage 4 Complete: All Core Business Features Done"
```

**ğŸ¯ é˜¶æ®µ4å®Œæˆæ£€æŸ¥ç‚¹**:
- [ ] æ‰€æœ‰ä¸šåŠ¡æ¨¡å—æµ‹è¯•é€šè¿‡
- [ ] AIé›†æˆæ­£å¸¸å·¥ä½œï¼ˆMockæµ‹è¯•ï¼‰
- [ ] èƒ½åŠ›è¿½è¸ªé€»è¾‘æ­£ç¡®
- [ ] APIæ–‡æ¡£å®Œæ•´æ›´æ–°
- [ ] æ•°æ®åº“è¿ç§»å…¨éƒ¨å®Œæˆ

**ğŸ’¾ å¼ºçƒˆå»ºè®®åœ¨æ­¤è¿›è¡ŒClaude Compact**: åç«¯å¼€å‘å®Œæˆï¼Œä¸Šä¸‹æ–‡å¾ˆé•¿

---

## é˜¶æ®µ5: å‰ç«¯å¼€å‘ (Flutter Frontend)

**æ³¨æ„**: å‰ç«¯å¼€å‘æ¯ä¸ªè¿­ä»£ä»£ç é‡è¾ƒå¤§ï¼Œå»ºè®®æ‹†åˆ†æ›´ç»†æˆ–è°ƒæ•´ä¸º1500è¡Œé™åˆ¶

### Iteration 5.1: Flutteré¡¹ç›®åŸºç¡€æ¶æ„

**ç›®æ ‡**: åˆ›å»ºFlutteré¡¹ç›®ã€é…ç½®ä¾èµ–ã€æ­å»ºåŸºç¡€æ¶æ„

**ä»£ç é‡ä¼°ç®—**: ~800è¡Œ

#### 1. åˆ†æ (Analysis)

**éœ€æ±‚åˆ†æ**:
- åˆ›å»ºFlutteré¡¹ç›®
- é…ç½®æ‰€æœ‰ä¾èµ–åŒ…
- æ­å»ºç›®å½•ç»“æ„
- é…ç½®APIæœåŠ¡åŸºç¡€
- é…ç½®ä¸»é¢˜å’Œè·¯ç”±

#### 2. è®¾è®¡ (Design)

**ç›®å½•ç»“æ„**:
```
frontend/nail_app/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ api_config.dart
â”‚   â”‚   â”œâ”€â”€ app_config.dart
â”‚   â”‚   â””â”€â”€ theme_config.dart
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ api_service.dart
â”‚   â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â””â”€â”€ splash_screen.dart
â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â””â”€â”€ common/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ app_router.dart
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ constants.dart
â”‚   â””â”€â”€ main.dart
â”œâ”€â”€ test/
â”œâ”€â”€ pubspec.yaml
â””â”€â”€ analysis_options.yaml
```

#### 3. å®ç° (Implementation)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»ºFlutteré¡¹ç›®:
  ```bash
  cd frontend
  flutter create nail_app
  cd nail_app
  ```
- [ ] å¤åˆ¶`pubspec_template.yaml`å†…å®¹åˆ°`pubspec.yaml`
- [ ] åˆ›å»ºç›®å½•ç»“æ„
- [ ] å®ç°`lib/config/api_config.dart`
- [ ] å®ç°`lib/config/theme_config.dart`
- [ ] å®ç°`lib/services/api_service.dart`ï¼ˆDioé…ç½®ï¼‰
- [ ] å®ç°`lib/routes/app_router.dart`
- [ ] å®ç°`lib/main.dart`
- [ ] è¿è¡Œ`flutter pub get`

#### 4-6. æµ‹è¯•ã€æ ¡å¯¹ã€Commit

**CommitèŠ‚ç‚¹**:
```bash
git add frontend/nail_app
git commit -m "feat(frontend): initialize Flutter project architecture

- Create Flutter project structure
- Configure dependencies (dio, provider, go_router, etc.)
- Setup API service with Dio interceptors
- Configure app theme and routing
- Add splash screen

Estimated lines: ~800
Status: âœ… App builds and runs"
```

---

### Iteration 5.2 - 5.6: å…¶ä»–å‰ç«¯è¿­ä»£

ï¼ˆåç»­å‰ç«¯è¿­ä»£è¯¦ç»†è§„åˆ’çœç•¥ï¼Œæ¯ä¸ªè¿­ä»£åŒ…æ‹¬ï¼šè®¤è¯ç•Œé¢ã€å®¢æˆ·ç®¡ç†ç•Œé¢ã€è®¾è®¡ç”Ÿæˆç•Œé¢ã€æœåŠ¡è®°å½•ç•Œé¢ã€èƒ½åŠ›ä¸­å¿ƒç•Œé¢ï¼‰

æ¯ä¸ªè¿­ä»£éµå¾ªç›¸åŒçš„æµç¨‹ï¼šåˆ†æ â†’ è®¾è®¡ â†’ å®ç° â†’ æµ‹è¯• â†’ æ ¡å¯¹ â†’ Commit

---

## æ€»ç»“ä¸å»ºè®®

### å¼€å‘èŠ‚å¥å»ºè®®

1. **æ¯æ—¥å·¥ä½œé‡**: å»ºè®®æ¯å¤©å®Œæˆ1-2ä¸ªè¿­ä»£
2. **Code Review**: æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µåè¿›è¡Œä»£ç å®¡æŸ¥
3. **æµ‹è¯•ä¼˜å…ˆ**: å…ˆå†™æµ‹è¯•ç”¨ä¾‹ï¼Œå†å®ç°åŠŸèƒ½ï¼ˆTDDå¯é€‰ï¼‰
4. **å°æ­¥å¿«è·‘**: æ¯ä¸ªcommitä¿æŒå°è€Œèšç„¦

### Claude Compactæ—¶æœº

å»ºè®®åœ¨ä»¥ä¸‹æ—¶æœºæ‰§è¡ŒClaude compact:
- âœ… å®Œæˆé˜¶æ®µ1ï¼ˆæ¡†æ¶å±‚ï¼‰å
- âœ… å®Œæˆé˜¶æ®µ2ï¼ˆåŸºç¡€æ¨¡å—ï¼‰å
- âœ… å®Œæˆé˜¶æ®µ3ï¼ˆAIå±‚ï¼‰å
- âœ… å®Œæˆé˜¶æ®µ4ï¼ˆä¸šåŠ¡æ¨¡å—ï¼‰å
- âœ… å¼€å§‹å‰ç«¯å¼€å‘å‰

### è´¨é‡æ§åˆ¶æ£€æŸ¥æ¸…å•

æ¯ä¸ªè¿­ä»£å®Œæˆåæ£€æŸ¥:
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆpytest -vï¼‰
- [ ] ä»£ç æ ¼å¼åŒ–ï¼ˆblack .ï¼‰
- [ ] ä»£ç æ£€æŸ¥ï¼ˆflake8ï¼‰
- [ ] ç±»å‹æ£€æŸ¥ï¼ˆmypy appï¼Œå¯é€‰ï¼‰
- [ ] APIæ–‡æ¡£æ›´æ–°
- [ ] Git commitä¿¡æ¯æ¸…æ™°
- [ ] æ²¡æœ‰é—ç•™TODOæˆ–FIXME

### é£é™©ç®¡ç†

**é«˜é£é™©é¡¹**:
1. **AI APIè°ƒç”¨æˆæœ¬**: OpenAI APIæŒ‰è°ƒç”¨æ”¶è´¹ï¼Œå¼€å‘é˜¶æ®µä½¿ç”¨Mockæµ‹è¯•
2. **å›¾ç‰‡å­˜å‚¨ç©ºé—´**: æ³¨æ„ç£ç›˜ç©ºé—´ï¼Œå®šæœŸæ¸…ç†æµ‹è¯•æ•°æ®
3. **æ•°æ®åº“è¿ç§»**: æ¯æ¬¡è¿ç§»å‰å¤‡ä»½æ•°æ®

**ç¼“è§£æªæ–½**:
- å¼€å‘é˜¶æ®µç”¨Mockæµ‹è¯•ï¼Œå‡å°‘AIè°ƒç”¨
- è®¾ç½®æµ‹è¯•æ•°æ®è‡ªåŠ¨æ¸…ç†è„šæœ¬
- ä½¿ç”¨Alembicæ­£ç¡®ç®¡ç†è¿ç§»

---

## å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# åç«¯
cd backend
uvicorn app.main:app --reload          # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pytest -v                               # è¿è¡Œæµ‹è¯•
black .                                 # æ ¼å¼åŒ–ä»£ç 
alembic revision --autogenerate -m ""   # åˆ›å»ºè¿ç§»
alembic upgrade head                    # åº”ç”¨è¿ç§»

# å‰ç«¯
cd frontend/nail_app
flutter run                             # è¿è¡Œåº”ç”¨
flutter test                            # è¿è¡Œæµ‹è¯•
flutter pub run build_runner build      # ç”Ÿæˆä»£ç 

# Git
git status                              # æŸ¥çœ‹çŠ¶æ€
git add .                               # æš‚å­˜æ”¹åŠ¨
git commit -m "feat: description"       # æäº¤
git log --oneline                       # æŸ¥çœ‹å†å²
```

### Commitæ¶ˆæ¯è§„èŒƒ

```
feat(scope): ç®€çŸ­æè¿°

- è¯¦ç»†æ”¹åŠ¨1
- è¯¦ç»†æ”¹åŠ¨2

Estimated lines: ~XXX
Status: âœ… Description
```

**ç±»å‹**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: Bugä¿®å¤
- `refactor`: é‡æ„
- `test`: æµ‹è¯•
- `docs`: æ–‡æ¡£
- `chore`: æ„å»º/å·¥å…·

**Scope**:
- `backend`
- `frontend`
- `database`
- `ai`

---

## é™„å½•ï¼šå®Œæ•´è¿­ä»£åˆ—è¡¨

| è¿­ä»£ID | åç§° | ä»£ç é‡ | çŠ¶æ€ |
|--------|------|--------|------|
| 1.1 | æ•°æ®åº“åŸºç¡€è®¾æ–½ | ~300è¡Œ | â³ |
| 1.2 | è®¤è¯ä¸æˆæƒç³»ç»Ÿ | ~800è¡Œ | â³ |
| 1.3 | æ–‡ä»¶ä¸Šä¼ æœåŠ¡ | ~400è¡Œ | â³ |
| 1.4 | é”™è¯¯å¤„ç†ä¸æ—¥å¿— | ~350è¡Œ | â³ |
| 1.5 | APIæ–‡æ¡£ä¸å¥åº·æ£€æŸ¥ | ~200è¡Œ | â³ |
| 2.1 | ç”¨æˆ·ç®¡ç†æ¨¡å— | ~500è¡Œ | â³ |
| 2.2 | å®¢æˆ·æ¡£æ¡ˆç®¡ç† | ~600è¡Œ | â³ |
| 2.3 | å®¢æˆ·è¯¦ç»†æ¡£æ¡ˆ | ~700è¡Œ | â³ |
| 3.1 | AI ProvideræŠ½è±¡æ¥å£ | ~400è¡Œ | â³ |
| 3.2 | OpenAI Providerå®ç° | ~900è¡Œ | â³ |
| 4.1 | çµæ„Ÿå›¾åº“ç®¡ç† | ~550è¡Œ | â³ |
| 4.2 | AIè®¾è®¡æ–¹æ¡ˆç”Ÿæˆ | ~800è¡Œ | â³ |
| 4.3 | è®¾è®¡æ–¹æ¡ˆå¾®è°ƒ | ~500è¡Œ | â³ |
| 4.4 | æœåŠ¡è®°å½•ç®¡ç† | ~600è¡Œ | â³ |
| 4.5 | AIå¯¹æ¯”åˆ†æ | ~700è¡Œ | â³ |
| 4.6 | èƒ½åŠ›ç»´åº¦ç®¡ç† | ~400è¡Œ | â³ |
| 4.7 | èƒ½åŠ›åˆ†æä¸å¯è§†åŒ– | ~850è¡Œ | â³ |
| 5.1 | FlutteråŸºç¡€æ¶æ„ | ~800è¡Œ | â³ |
| 5.2 | è®¤è¯ä¸ç”¨æˆ·æ¨¡å— | ~900è¡Œ | â³ |
| 5.3 | å®¢æˆ·ç®¡ç†ç•Œé¢ | ~950è¡Œ | â³ |
| 5.4 | è®¾è®¡ç”Ÿæˆç•Œé¢ | ~1000è¡Œ | â³ |
| 5.5 | æœåŠ¡è®°å½•ç•Œé¢ | ~900è¡Œ | â³ |
| 5.6 | èƒ½åŠ›ä¸­å¿ƒç•Œé¢ | ~950è¡Œ | â³ |

**æ€»è®¡**: 23ä¸ªè¿­ä»£ï¼Œçº¦15,000è¡Œä»£ç 

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2024-01-08
**æœ€åæ›´æ–°**: 2024-01-08
